---
title: ' '
# output:
#   prettydoc::html_pretty:
#     theme: architect
#     toc: true
#     toc_collapsed: true
#     toc_depth: 3
#     number_sections: false
output:
  bookdown::html_document2:
    #css: style.css
    theme: cerulean
    toc: false
    number_sections: false
params:
  data: AFG

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,warning = F,message = F)
```


```{r}
## Creating path & Load files  
## To change country of concern and hyperparameters here
country <- params$data
#country <-"MEX"
id_of_country <- mig.stock |> filter(iso3 == country) |> pull(area.id) |> unique()
sub_of_country <- mig.stock |> filter(iso3 == country) |> pull(subregion) |> unique()
sub_of_country <- ifelse(is.na(sub_of_country),'Northern America',sub_of_country)
name_of_country <- mig.stock |> filter(iso3 == country) |> pull(area) |> unique()

write_years<- 10
carry_data <- function(x) ave(x, cumsum(!is.na(x)), FUN = function(i){ i[1:pmin(length(i), write_years+1)] <- i[1]; i }) # function to carry forward data for specific years

country.wpp.sub.id <- wpp.location |> filter(iso3 == country) |> pull(subregion.id)
country.wpp.sub <- wpp.location |> filter(iso3 == country) |> pull(subregion)
country.wpp.insub <- wpp.location |> filter(subregion == country.wpp.sub) |> pull(iso3)
country.wpp.name <- wpp.location |>filter(iso3 == country) |> pull(area)
```  


```{r}
#filtering wpp databases
wpp.age.group.country <- wpp.age.group |> 
  filter((year %in% c(2000,2022,2050) & iso3 == country)|
           (year == 2022 & area.id == country.wpp.sub.id)|
           (year == 2022 & area.id == 900))|>
  mutate(year = paste(year,area,sep = " "))
wup.country <- wup |>
  filter((year %in% c(2000,2022,2050) & iso3 == country)|
           (year == 2022 & area.id == country.wpp.sub.id)|
           (year == 2022 & area.id == 900))|>
  mutate(year = paste(year,area,sep = " "))
wpp.age.group.pct.country <- wpp.age.group.pct |>
  filter((year %in% c(2000,2022,2050) & iso3 == country)|
           (year == 2022 & area.id == country.wpp.sub.id)|
           (year == 2022 & area.id == 900))|>
  mutate(year = paste(year,area,sep = " "))
wpp.dem.country <- wpp.dem |>
  filter((year %in% c(2000,2022,2050) & iso3 == country)|
           (year == 2022 & area.id == country.wpp.sub.id)|
           (year == 2022 & area.id == 900))|>
  mutate(year = paste(year,area,sep = " "))
wpp.asfr.country <- wpp.asfr |>
  filter((year %in% c(2000,2022,2050) & age.group == '15to19'& iso3 == country)|
           (year == 2022 & age.group == '15to19' & area.id %in% c(country.wpp.sub.id,900)))|>
  mutate(year = paste(year,area,sep = " "))

#Building population table to print
pop.df <- wpp.age.group.country |>
  select(year, 'Total population (thousand)' = poptotal.thsd) |>
  left_join(wpp.age.group.country |> 
              mutate(pop5to17.thsd = pop5to10.thsd+pop11to17.thsd) |> 
              select(year, 'Population 65+ (thousand) - "elderly"' = pop65plus.thsd,
                     'Population 15-65 (thousand) - "working age"' = pop15to64.thsd,
                     'Population 15-24 (thousand) - "youth"' = pop15to24.thsd,
                     'Population under age 18 (thousand)- "children"' = pop0to17.thsd,
                     'Population in school age (5-17) (thousand)' = pop5to17.thsd,
                     'Population under 5 (thousand)' = pop0to4.thsd), by = 'year') |>
  left_join(wup.country |>
              filter(residence == 'urban') |>
              mutate(area = ifelse(area == 'World','WORLD',area)) |>
              mutate(pop.pct = round(pop.pct,1)) |>
              select(year,'Share of urban population (%)' = pop.pct), by = 'year') |>
  left_join(wpp.age.group.pct.country |>
              mutate_at(c('pop65plus.pct', 'pop15to64.pct','pop0to17.pct','pop0to14.pct'  ),round,1) |> 
              select(year, 'Share Population aged 65+ (%)' = pop65plus.pct, 
                     'Share Population aged 15-64 (%)' = pop15to64.pct ,
                     'Share Population under age 18 (%)' = pop0to17.pct,
                     'Share Population under age 15 (%)' = pop0to14.pct), by = 'year') |>
  left_join(wpp.dem.country |>
              select(year, 'Total fertility (live births per woman)' = tfr,
                     'Life expectancy at birth (years)' = le,
                     'Neonatal mortality rate (deaths per 1 000 live births)' = imr,
                     'Under five mortality rate (deaths per 1 000 live births)' = u5mr), by = 'year') |>
  left_join(wpp.asfr.country|>
              select(year,'Adolescent fertility rate (births per 1 000 women ages 15-19)' = asfr), by = 'year') |>
  left_join(wpp.dem.country |> 
              select(year,'Births (thousand)' = births.thsd), by = 'year')
```  

# `r country.wpp.name` 
  
-------  

## Section 1: Migration and Displacement  

-------  


```{r}
#######################################
areas <- wpp.location |> filter(!is.na(region)) |> distinct(region) |> pull(region)
pct_regions <- mig.stock.pct  |> 
  filter(year == 2020, sex == 'both') |> 
  filter(area  == 'WORLD'| iso3 == country | loctype %in% c('Geographic region','Subregion')) |>
  select(area,iso3,pop.mig.pct) |>
  rbind(c('Americas',NA, 7.186)) |>
  mutate(non_mig = 1-as.numeric(pop.mig.pct)/100, 
         mig = as.numeric(pop.mig.pct)/100,
         pct = paste0(round(as.numeric(pop.mig.pct),1), '%'))
# 
# data4 <- pct_regions |> filter(area %in% c('WORLD',sub_of_country) | iso3 == country) |> gather(key = type ,value = pop,4:5) |> mutate(pct = ifelse(type == 'mig', pct, NA))

mig.df <- mig.stock.0to17 |>
  filter(year == 2020 , iso3 == country, sex == 'both')  |>
  mutate(year = paste(year,country.wpp.name,sep = " "),pop.mig.total = pop.mig.total/1000, pop.mig.0to17 = pop.mig.0to17/1000) |>
  select(year,'International migrant stock (thousand)' = pop.mig.total,'International migrant stock under age 18 (thousand)' = pop.mig.0to17,'Share under 18 among international migrant stock (%)' = pop.mig.0to17.pct) |>
  rbind(mig.stock.0to17 |> 
          filter(year == 2020 , iso3 %in% country.wpp.insub, sex == 'both') |>
          summarise('International migrant stock (thousand)' = sum(pop.mig.total/1000,na.rm = T),
                    'International migrant stock under age 18 (thousand)' = sum(pop.mig.0to17/1000,na.rm = T) , .groups='drop') |>
          mutate('Share under 18 among international migrant stock (%)' = `International migrant stock under age 18 (thousand)`/`International migrant stock (thousand)`*100, year = c(paste(2020,country.wpp.sub,sep = ' ')))) |>
  rbind(mig.stock.0to17 |> 
          filter(year == 2020 , area.id < 900, sex == 'both') |>
          summarise('International migrant stock (thousand)' = sum(pop.mig.total/1000,na.rm = T),
                    'International migrant stock under age 18 (thousand)' = sum(pop.mig.0to17/1000,na.rm = T) , .groups='drop') |>
          mutate('Share under 18 among international migrant stock (%)' = `International migrant stock under age 18 (thousand)`/`International migrant stock (thousand)`*100, year = '2020 WORLD')) |>
  cbind(mig.stock.ref |> 
          filter(year == 2020, iso3 == country, indic == 'ref') |>
          mutate(pop.mig = pop.mig/1000) |>
          select('Share of refugees among international migrant stock (%)' = pop.mig) |>
          rbind(mig.stock.ref |>
                  filter(year == 2020, iso3 %in% country.wpp.insub, indic == 'ref') |>
                  summarise('Share of refugees among international migrant stock (%)' = sum(pop.mig/1000, na.rm =T), .groups='drop')) |>
          rbind(mig.stock.ref |>
                  filter(year == 2020, area.id < 900, indic == 'ref') |>
                  summarise('Share of refugees among international migrant stock (%)' = sum(pop.mig/1000, na.rm =T), .groups='drop')))  |>
  mutate(`Share of refugees among international migrant stock (%)` = `Share of refugees among international migrant stock (%)`/`International migrant stock (thousand)`*100) |>
  left_join(pct_regions |> 
              filter(area %in% c('WORLD',sub_of_country) | iso3 == country) |> 
              mutate(area = paste0(2020,' ',area), mig = mig*100) |> 
              select(area,'Share of international migrants as part of whole population (%)' = mig), by = c('year' = 'area')) |> 
  select(1,2,6,3,4,5)

#####################################

ref.df <- unhcr.gt.tab12.new |>
  mutate(area.id = ifelse(area.unhcr == 'World',900,area.id)) |>
  left_join(wpp.age.group |> filter(year == 2022) |> select(area.id,poptotal.thsd), by = 'area.id') |>
  left_join(wpp.location |> select(area.id, wpp.subregion = subregion), by = 'area.id') |> 
  filter(iso3 %in% c(country,'XXX'), pop.type == 'Refugees') |>
  mutate(prop.ref.0to17.asy = prop.ref.0to17.asy*100, prop.women = pop.ref.total.fem.asy/pop.ref.data.available.asy*100, share.ref = pop.ref.asy/(poptotal.thsd*1000)*100,year = ifelse(iso3 == country, paste(year,country.wpp.name,sep = " "),'2022 WORLD'), share.ref.schoolage = ifelse(coverage.sex.age.asy>=0.5, (pop.ref.5to11.fem.asy+pop.ref.12to17.fem.asy+pop.ref.5to11.male.asy+pop.ref.12to17.male.asy)/(pop.ref.total.male.asy + pop.ref.total.fem.asy -pop.ref.unknown.male.asy - pop.ref.unknown.fem.asy)*100,NA), ref.schoolage = pop.ref.asy*share.ref.schoolage/100) |>
  select(year, 'Refugees (thousand)' = pop.ref.asy,
         'Refugees under age 18 (thousand)' = pop.ref.0to17.asy, 
         'Share under 18 among refugees (%)' = prop.ref.0to17.asy,
         'Share women among refugees (%)' = prop.women,
         'Share of the population who are refugees (%)' = share.ref,
         'Refugees in school age (5-17 years) (thousand)' = ref.schoolage,
         'Share of refugees in school age (5-17 years) (%)' = share.ref.schoolage) |>
  rbind(unhcr.gt.tab12.new |> mutate(area.id = ifelse(area.unhcr == 'World',900,area.id)) |>
          left_join(wpp.age.group |> filter(year == 2022) |> select(area.id,poptotal.thsd), by = 'area.id') |>
          left_join(wpp.location |> select(area.id, wpp.subregion = subregion), by = 'area.id') |> 
          filter(wpp.subregion == country.wpp.sub, pop.type == 'Refugees') |>
          summarise( 'Refugees (thousand)' = sum(pop.ref.asy,na.rm=T),
                     'Refugees under age 18 (thousand)' = sum(pop.ref.0to17.asy,na.rm = T),
                     'Share under 18 among refugees (%)' = sum(pop.ref.0to17.asy,na.rm = T)/sum(pop.ref.asy,na.rm = T)*100,
                     'Share women among refugees (%)' = sum(pop.ref.total.fem.asy,na.rm = T)/sum(pop.ref.data.available.asy, na.rm = T)*100,
                     'Share of the population who are refugees (%)' = sum(pop.ref.asy,na.rm = T)/sum(poptotal.thsd*1000,na.rm = T)*100,
                     'Share of refugees in school age (5-17 years) (%)' = weighted.mean(ifelse(coverage.sex.age.asy>=0.5, (pop.ref.5to11.fem.asy+pop.ref.12to17.fem.asy+pop.ref.5to11.male.asy+pop.ref.12to17.male.asy)/(pop.ref.total.male.asy + pop.ref.total.fem.asy -pop.ref.unknown.male.asy - pop.ref.unknown.fem.asy)*100,NA),pop.ref.asy,na.rm = T),
                     .groups='drop') |>
          mutate('Refugees in school age (5-17 years) (thousand)' = `Refugees (thousand)`*`Share of refugees in school age (5-17 years) (%)`/100, year= c(paste0('2022',' ',country.wpp.sub)))) |>
  left_join(unhcr.gt.tab18.new |>
              filter(`Population type1` == 'Refugees', `ISO code` == country) |>
              mutate(coverage = (Total- `Undefined/ unknown`)/Total) |>
              mutate(pop.camp = ifelse(coverage >= 0.5,`Planned/ managed camp`+`Collective center`+`Self-settled camp`+`Reception/ transit camp`,NA) ) |> 
              mutate(prop.camp = pop.camp/(Total-`Undefined/ unknown`)*100) |> 
              mutate(pop.camp.est = Total*prop.camp/100) |>
              select('Refugees living in camps (thousand)' = pop.camp.est,
                     'Share of refugees living in camps (%)' = prop.camp) |> 
              mutate( year = paste0(2022,' ',country.wpp.name)) |>
              rbind(unhcr.gt.tab18.new  |> 
                      left_join(wpp.location |> select(iso3, wpp.subregion = subregion), by = c('ISO code' = 'iso3')) |>
                      filter(`Population type1` == 'Refugees', wpp.subregion == country.wpp.sub) |>
                      mutate(coverage = (Total- `Undefined/ unknown`)/Total) |> 
                      mutate(pop.camp = ifelse(coverage >= 0.5,`Planned/ managed camp`+`Collective center`+`Self-settled camp`+`Reception/ transit camp`,NA) ) |>
                      mutate(prop.camp = pop.camp/(Total-`Undefined/ unknown`)) |> 
                      summarise(Total_sub = sum(Total,na.rm = T),
                                prop.camp_sub = weighted.mean(prop.camp,Total,na.rm =T)*100, .groups='drop')|>
                      mutate(pop.camp.est = Total_sub*prop.camp_sub/100) |>
                      select('Refugees living in camps (thousand)' = pop.camp.est,
                             'Share of refugees living in camps (%)' = prop.camp_sub) |>
                      mutate( year = paste0(2022,' ',country.wpp.sub))) |>
              rbind(unhcr.gt.tab18.new |> 
                      filter(`Population type1` == 'Refugees') |>
                      mutate(coverage = (Total- `Undefined/ unknown`)/Total) |> 
                      mutate(pop.camp = ifelse(coverage >= 0.5,`Planned/ managed camp`+`Collective center`+`Self-settled camp`+`Reception/ transit camp`,NA) ) |>
                      mutate(prop.camp = pop.camp/(Total-`Undefined/ unknown`)) |>
                      summarise(Total_sub = sum(Total,na.rm = T),prop.camp_sub = weighted.mean(prop.camp,Total,na.rm =T)*100,
                                .groups='drop')|>
                      mutate(pop.camp.est = Total_sub*prop.camp_sub/100) |>
                      select('Refugees living in camps (thousand)' = pop.camp.est,
                             'Share of refugees living in camps (%)' = prop.camp_sub) |>
                      mutate( year = '2022 WORLD')), by = 'year') |>
  mutate_at(vars(contains('thousand')),~round(./1000,1)) 

####################################

idp.df <- idmc.conf.dis.2022 |>  
  filter(year == 2022, iso3 == country) |> 
  left_join(wpp.age.group.pct |> select(year,iso3,pop0to4.pct),by = c('year','iso3'))  |>
  mutate_if(is.numeric,replace_na,0) |>
  mutate(pop5to17.pct = pop0to17.pct- pop0to4.pct, 
         idp.total = idp.conf.stock+idp.dis.stock, 
         idp.total.0to17 = idp.conf.stock.0to17+idp.dis.stock.0to17, 
         idp.total.schoolage = idp.conf.stock*pop5to17.pct/100+idp.dis.stock*pop5to17.pct/100, 
         prop.conf = idp.conf.stock/idp.total*100,
         idp.total.new = idp.dis.new+idp.conf.new,
         prop.conf.new = idp.conf.new/idp.total.new*100,
         year = paste0(2022, ' ', country.wpp.name)) |>
  select(year, 'Internally displaced persons (IDPs) (thousand)' = idp.total, 
         'Internally displaced persons (IDPs) under age 18 (thousand)' = idp.total.0to17, 
         'Internally displaced persons (IDPs) in school age (5-17) (thousand)' = idp.total.schoolage ,
         'Share of Internally displaced persons (IDPs) due to conflict and violence (%)' = prop.conf, 
         'New internal displacements (thousand)' = idp.total.new, 
         'Share of new internal displacements due to conflict and violence (%)' = prop.conf.new) |>
  rbind(idmc.conf.dis.2022  |> 
          left_join(wpp.age.group.pct |> 
                      select(year,iso3,pop0to4.pct),by = c('year','iso3.join' = 'iso3')) |> 
          left_join(wpp.location |> select(iso3,wpp.subregion = subregion), by = 'iso3' )|> 
          mutate_if(is.numeric,replace_na,0)  |>
          mutate(wpp.subregion = ifelse(iso3 == 'AB9', 'Eastern Africa',wpp.subregion)) |>
          mutate(wpp.subregion = ifelse(iso3 == 'XKX', 'Southern Europe',wpp.subregion)) |> 
          filter(year == 2022, wpp.subregion == country.wpp.sub)|> 
          mutate(pop5to17.pct = pop0to17.pct- pop0to4.pct, 
                 idp.total = idp.conf.stock+idp.dis.stock,
                 idp.total.0to17 = idp.conf.stock.0to17+idp.dis.stock.0to17, 
                 idp.total.schoolage = idp.conf.stock*pop5to17.pct/100+idp.dis.stock*pop5to17.pct/100, 
                 prop.conf = idp.conf.stock/idp.total*100, 
                 idp.total.new = idp.dis.new+idp.conf.new, 
                 prop.conf.new = idp.conf.new/idp.total.new*100 ) |>
          summarise( 'Internally displaced persons (IDPs) (thousand)' = sum(idp.total,na.rm = T), 
                     'Internally displaced persons (IDPs) under age 18 (thousand)' = sum(idp.total.0to17,na.rm = T), 
                     'Internally displaced persons (IDPs) in school age (5-17) (thousand)' = sum(idp.total.schoolage,na.rm =T) ,
                     'Share of Internally displaced persons (IDPs) due to conflict and violence (%)' = weighted.mean(prop.conf,idp.total,na.rm = T) , 
                     'New internal displacements (thousand)' = sum(idp.total.new,na.rm = T),
                     'Share of new internal displacements due to conflict and violence (%)' = weighted.mean(prop.conf.new,idp.total.new,na.rm = T), 
                     .groups='drop') |>
          mutate(year = paste0(2022, ' ', country.wpp.sub))) |> 
  rbind(idmc.conf.dis.2022  |> 
          left_join(wpp.age.group.pct |> 
                      select(year,iso3,pop0to4.pct),by = c('year','iso3.join'= 'iso3')) |>
          filter(year == 2022)|> 
          mutate_if(is.numeric,replace_na,0)  |>
          mutate(pop5to17.pct = pop0to17.pct- pop0to4.pct, 
                 idp.total = idp.conf.stock+idp.dis.stock, 
                 idp.total.0to17 = idp.conf.stock.0to17+idp.dis.stock.0to17, 
                 idp.total.schoolage = idp.conf.stock*pop5to17.pct/100+idp.dis.stock*pop5to17.pct/100,
                 prop.conf = idp.conf.stock/idp.total*100, 
                 idp.total.new = idp.dis.new+idp.conf.new, 
                 prop.conf.new = idp.conf.new/idp.total.new*100) |>
          summarise( 'Internally displaced persons (IDPs) (thousand)' = sum(idp.total,na.rm = T),
                     'Internally displaced persons (IDPs) under age 18 (thousand)' = sum(idp.total.0to17,na.rm = T),
                     'Internally displaced persons (IDPs) in school age (5-17) (thousand)' = sum(idp.total.schoolage,na.rm =T) ,
                     'Share of Internally displaced persons (IDPs) due to conflict and violence (%)' = weighted.mean(prop.conf,idp.total,na.rm = T) ,
                     'New internal displacements (thousand)' = sum(idp.total.new,na.rm = T), 
                     'Share of new internal displacements due to conflict and violence (%)' = weighted.mean(prop.conf.new,idp.total.new,na.rm = T), .groups='drop') |>
          mutate(year = '2022 WORLD')) |> 
  mutate_at(vars(contains('thousand')),~round(./1000,1)) 

########################################

country.wb.remittance.df <- wb.remittance.df |> 
  filter(`Country Code` %in% c(country,"WLD")) |>
  mutate(year = ifelse(`Country Code` == 'WLD','2021 WORLD',paste0(2021, ' ', country.wpp.name))) |>
  select(year, rem.us , rem.pct) |>
  rbind(wb.remittance.df |> mutate(`Country Code` = ifelse(`Country Code` == 'XKX', 'SRB',`Country Code`)) |>
          left_join(wpp.location |> select(iso3,wpp.area = area,wpp.subregion = subregion), by = c('Country Code' = 'iso3')) |>
          left_join(wpp.age.group |> filter(area.id<900, year == 2021) |> select(iso3,poptotal.thsd), by = c('Country Code' = 'iso3')) |>
          filter(wpp.subregion == country.wpp.sub) |>
          summarise(year = paste0(2021, ' ', country.wpp.sub), rem.us = sum(rem.us,na.rm = T), rem.pct = weighted.mean(rem.pct,poptotal.thsd,na.rm = T))) |>
  select(year,'Personal remittances, received (current million USD)' = rem.us, 'Personal remittances, received (% of GDP)' = rem.pct)


########################################

ref.uis.ctry <- ref.school |> filter(COUNTRIES == country.wpp.name)
if(nrow(ref.uis.ctry)!= 0){
  ref.uis.df <- data.frame(year = paste0('2019 ', country.wpp.name), 
                           'GROSS ENROLMENT, Pre-primary' = ref.uis.ctry |> pull('T...15'),
                           'GROSS ENROLMENT, Primary' = ref.uis.ctry |> pull('T...18'),
                           'GROSS ENROLMENT, Secondary' = ref.uis.ctry |> pull('T...21'),
                           'GROSS ENROLMENT RATE, Pre-primary' =  ref.uis.ctry |> pull('T...33')*100,
                           'GROSS ENROLMENT RATE, Primary' =  ref.uis.ctry |> pull('T...36')*100,
                           'GROSS ENROLMENT RATE, Secondary' =  ref.uis.ctry |> pull('T...39')*100)
  
  colnames(ref.uis.df) <- c('year',
                            'Gross enrollment (pre-primary)',
                            'Gross enrollment (primary)',
                            'Gross enrollment (secondary)',
                            'Gross enrollment rate (pre-primary) (%)',
                            'Gross enrollment rate (primary) (%)',
                            'Gross enrollment rate (secondary) (%)')
} else {
  ref.uis.df <- data.frame(year = paste0('2019 ', country.wpp.name), 
                           'GROSS ENROLMENT, Pre-primary' = NA,
                           'GROSS ENROLMENT, Primary' = NA ,
                           'GROSS ENROLMENT, Secondary' = NA,
                           'GROSS ENROLMENT RATE, Pre-primary' =  NA,
                           'GROSS ENROLMENT RATE, Primary' =  NA,
                           'GROSS ENROLMENT RATE, Secondary' =  NA)
  
  colnames(ref.uis.df) <- c('year',
                            'Gross enrollment (pre-primary)',
                            'Gross enrollment (primary)',
                            'Gross enrollment (secondary)',
                            'Gross enrollment rate (pre-primary) (%)',
                            'Gross enrollment rate (primary) (%)',
                            'Gross enrollment rate (secondary) (%)')
}

########################################

dt_mig_2020 <- mig.df |> 
  pivot_longer(-year) |> 
  pivot_wider(names_from=year, values_from=value) |>
  select('Indicator' = name, ends_with(country.wpp.name),ends_with(country.wpp.sub),everything()) |>
  mutate(type = c("p","r","p","r","r")) |>
  mutate_if(is.numeric, ~ifelse(type=='p',format(round(.),big.mark = ' ',scientific = F),format(round(.,1),big.mark = ' ',scientific=F))) |> select(-type, '2020 World' = `2020 WORLD`)

#General Refugee Data frame
dt_ref <- tibble(year = paste0('2022 ',c(country.wpp.name,country.wpp.sub,'WORLD'))) |>
  left_join( ref.df, by = 'year')  |>
  #left_join(country.wb.remittance.df, by = 'year')  |>
  pivot_longer(-year) |> 
  pivot_wider(names_from=year, values_from=value) |>
  select('Indicator' = name, ends_with(country.wpp.name),ends_with(country.wpp.sub),everything()) |>
  mutate_at(vars(2:4),~ifelse(is.nan(.),NA,.)) |>
  mutate(type = c("p","p","r","r","r","p","r","p","r")) |>
  mutate_if(is.numeric, ~ifelse(type=='p',format(round(.),big.mark = ' ',scientific = F),format(round(.,1),big.mark = ' ',scientific=F))) |> select(-type, '2022 World' = `2022 WORLD`)
  
dt_idp <-  tibble(year = paste0('2022 ',c(country.wpp.name,country.wpp.sub,'WORLD'))) |>
  left_join( idp.df , by = 'year') |>
  pivot_longer(-year) |> 
  pivot_wider(names_from=year, values_from=value) |>
  select('Indicator' = name, ends_with(country.wpp.name),ends_with(country.wpp.sub),everything()) |>
  mutate(type = c("p","p","p","r","p","r")) |>
  mutate_if(is.numeric, ~ifelse(type=='p',format(round(.),big.mark = ' ',scientific = F),format(round(.,1),big.mark = ' ',scientific=F))) |> select(-type, '2022 World' = `2022 WORLD`)

dt_remit_2021 <- tibble(year = paste0('2021 ',c(country.wpp.name,country.wpp.sub,'WORLD'))) |>
  left_join( country.wb.remittance.df, by = 'year')  |>
  pivot_longer(-year) |> 
  pivot_wider(names_from=year, values_from=value) |>
  select('Indicator' = name, ends_with(country.wpp.name),ends_with(country.wpp.sub),everything()) |>
  mutate_at(vars(2:4),~ifelse(is.nan(.),NA,.)) |>
  mutate(type = c("p","r")) |>
  mutate_if(is.numeric, ~ifelse(type=='p',format(round(.),big.mark = ' ',scientific = F),format(round(.,1),big.mark = ' ',scientific=F))) |> select(-type, '2021 World' = `2021 WORLD`)

#Refugee education data frame  
dt_ref_edu_2019 <- tibble(year = paste0('2019 ',country.wpp.name)) |>
  left_join(ref.uis.df, by = 'year') |>
  pivot_longer(-year) |> 
  pivot_wider(names_from=year, values_from=value) |>
  rename('Indicator' = name) |>
  mutate_at(vars(2),~ifelse(is.nan(.),NA,.)) |>
  mutate(type = c("p","p","p","r","r","r")) |>
  mutate_if(is.numeric, ~ifelse(type=='p',format(round(.),big.mark = ' ',scientific = F),format(round(.,1),big.mark = ' ',scientific=F))) |> select(-type)

colnames(dt_mig_2020) <- c('Indicator', '2020' ,'2020' , '2020') 
colnames(dt_ref) <- c('Indicator', '2022' ,'2022' , '2022') 
colnames(dt_idp) <- c('Indicator', '2022' ,'2022' , '2022') 
colnames(dt_remit_2021) <- c('Indicator', '2021' ,'2021' , '2021') 
colnames(dt_ref_edu_2019) <- c('Indicator', '2019') 
 
# create vector with colspan
myHeader <- c(" " = 1, country.wpp.name = 1,country.wpp.sub = 1,'World' = 1)
names(myHeader) <- c(" ", country.wpp.name,country.wpp.sub,'World')
```

### International migration statistics
**International migrant stock**: For statistical purposes, the international migrant stock is defined as the foreign-born population residing in the country at a specific reference day (here 1 July of the reference year). If information on country of birth is not available, country of citizenship is used as criterion. Note that this definition does not include criterion related to an individual's reason for changing their country of residence or legal status. Thus, the international migrant stock explicitly includes refugees and irregular migrants. While in most countries refugees represent only a small share of the total migrant stock, in some countries the majority of the migrant stock may have refugee status. 
<br/>


```{r}
kable(dt_mig_2020[1:5,], align = c('l',rep('r',3))) |> 
  kable_classic(full_width = T) |>
  column_spec(1, bold = T, border_right = T,width = '12cm') |> 
  row_spec(1:5) |>
  add_header_above(myHeader) |> 
  row_spec( 0, extra_css = "border-top: 1px solid white")
```
 
 
<center>

<font size = 3> **Left: Trend in migrant stock, 1990-2020 (in thousands)<br>Right: Age pyramid of migrants and non-migrants, 2020<br>`r country.wpp.name`** </em></font>  

</center>  

#### 

```{r, out.width="50%", fig.show="hold"}
data2 <- mig.stock.ref |> 
  select(3,4,5,7) |> 
  filter(iso3 == country, indic %in% c('ref','ref_pct')) |> 
  spread(key = 'indic', value = 'pop.mig') |>
  left_join(mig.stock |> filter(sex == 'both') |> select(year,iso3,pop.mig), by = c('year','iso3')) |> 
  mutate(ref_pct = paste0(round(ref_pct,1),'%'),
         non_ref = pop.mig - ref) |> 
  gather(key = pop.type, value = population,c(3,6)) |>
  mutate(pop.type = factor(pop.type,levels = c('non_ref','ref'), labels = c('Non-refugees','Refugees')),
         pop.mig = scale_round_k(pop.mig),
         population = scale_round_k(population))

fig2 <- ggplot(data2,aes(x = as.factor(year), y = population, fill = pop.type, label = ref_pct))+
  geom_bar(stat='identity',alpha =0.7)+
  geom_text(data = data2 |> filter(pop.type == 'Refugees'), aes(y = population), size = 3,position = position_stack(vjust = 0.5)) +
  geom_text(data = data2 |> filter(pop.type == 'Non-refugees'), aes(y = pop.mig, label = pop.mig), vjust=0, size = 3) +
  scale_fill_manual(values = c(unicef_colors_bin[2], unicef_colors_bin[1]))+
  labs(y = 'Population',
       x = 'Year',
       fill = NULL)+
  blank_theme +
  theme(panel.grid.major.y = element_line(color=unicef_colors[9], linetype = "dashed"),
        legend.position = "bottom")

#age pyramid
pop.mig.male <- mig.stock.age |>
  filter(iso3 == country, year == 2020, sex == 'male',age.group == 'total') |>
  pull(pop.mig)
pop.mig.female <- mig.stock.age |>
  filter(iso3 == country, year == 2020, sex == 'female',age.group == 'total') |>
  pull(pop.mig)

pop.male <- wpp.age.group.male |>
  filter(iso3 == country, year == 2020) |>
  pull(poptotal.thsd) *1000
pop.female <- wpp.age.group.female |>
  filter(iso3 == country, year == 2020) |>
  pull(poptotal.thsd) *1000

data5 <- mig.stock.age |> filter(iso3 == country, year == 2020, sex != 'both', age.group != 'total') |> 
  select(4,pop = pop.mig,6) |>
  mutate(type = 'migrant') 

age_pyramid_female_non <- wpp.5y.age.group.female |>
  filter(area.id == id_of_country, year == 2020) |> select(5:25) |> 
  mutate(pop75plus.thsd = pop75to79.thsd+pop80to84.thsd+pop85to89.thsd+pop90to94.thsd+pop95to99.thsd+pop100plus.thsd) |>
  select(1:15, pop75plus.thsd) |> 
  gather(key = 'age.group', value = 'pop') |>
  mutate(age.group = str_replace(age.group,'pop','')) |>
  mutate(age.group = str_replace(age.group,'.thsd',''), pop = pop*1000, sex = 'female') |> 
  left_join(data5, by = c('age.group','sex')) |>
  mutate(pop = pop.x-pop.y, type = 'non-migrant') |>
  select(age.group,pop,sex,type) 

age_pyramid_male_non <- wpp.5y.age.group.male |>
  filter(area.id == id_of_country, year == 2020) |>
  select(5:25) |> 
  mutate(pop75plus.thsd = pop75to79.thsd+pop80to84.thsd+pop85to89.thsd+pop90to94.thsd+pop95to99.thsd+pop100plus.thsd) |>
  select(1:15, pop75plus.thsd) |> 
  gather(key = 'age.group', value = 'pop') |>
  mutate(age.group = str_replace(age.group,'pop','')) |>
  mutate(age.group = str_replace(age.group,'.thsd',''), pop = pop*1000, sex = 'male') |> 
  left_join(data5, by = c('age.group','sex')) |>
  mutate(pop = pop.x-pop.y, type = 'non-migrant') |> 
  select(age.group,pop,sex,type) 

data5 <- data5 |> bind_rows(age_pyramid_female_non,age_pyramid_male_non) |>
  group_by(type) |>
  mutate(pct = pop/sum(pop), age.group = factor(age.group,level = unique(age.group)))|> 
  left_join(age.group.labels, by="age.group")

fig5 <- ggplot(data=data5,aes(x = age.group.label, y = pct)) + 
  geom_bar(data=data5 |> filter(sex=='female', type=='migrant'), aes(fill='female'), stat='identity',alpha=0.4) + 
  geom_bar(data=data5 |> filter(sex=='male', type=='migrant'), aes(y=pct * -1, fill='male'), stat='identity', alpha=0.4) + 
  geom_bar(data=data5 |> filter(sex=='female', type=='non-migrant'), aes(color='female'), stat='identity', alpha=0) + 
  geom_bar(data=data5 |> filter(sex=='male', type=='non-migrant'), aes(y=pct * -1, color='male'), stat='identity', alpha=0) + 
  scale_y_continuous(breaks=seq(-0.08,0.08,0.02),labels=paste0(abs(seq(-8,8,2)),'%')) + 
  scale_fill_manual(values = unicef_colors)+
  scale_color_manual(values = unicef_colors)+
  coord_flip()+
  blank_theme +
  theme(axis.title.y = element_blank(),
        legend.position = "bottom")+
  labs(fill = 'migrant',
       color = 'non-migrant')

fig2
fig5
```

<font size = 1><em>***Source:*** United Nations, Department of Economic and Social Affairs, Population Division, 2020. International Migrant Stock 2020.</em></font>
  
#### International migration corridors
The migrant stock can be analyzed by country of origin and country of destination. The table below shows the top 3 destinations and origins of international migrants from and to `r country.wpp.name`.

  
```{r}
top_n_immi <- 3  #number of top immigration countries
top_n_emi <- 3 #number of top emigration countries

## helper function assigning iso to area
split_10 <- function(x) return(str_replace_all(x, "(.{9,}?)\\s",'\\1\n'))

concerned_ctries <- c(country, 
                      union(mig.stock.orig.dest |> filter(year == 2020 , orig.iso3 == country, dest.area.id < 900) |> 
                              top_n(top_n_emi,pop.mig) |> pull(dest.iso3),
                            mig.stock.orig.dest |>
                              filter(year == 2020 , dest.iso3 == country, orig.area.id < 900) |>
                              top_n(top_n_immi,pop.mig) |> pull(orig.iso3)))
concerned_regions <- wpp.location |> filter(iso3 %in% concerned_ctries) |> pull(region) |> unique()


areas_elaborate <- list()
for(i in c("Africa", "Asia" ,"Latin America and the Caribbean", "Oceania","Europe","Northern America" )){
  areas_elaborate[[ifelse(i %in% concerned_regions, paste0('Rest of\n', split_10(i)),split_10(i))]] <- wpp.location |> filter(region %in% i , !iso3 %in% concerned_ctries, !is.na(iso3)) |> pull(iso3)
}

  
area_switch <- function(iso3){
  area_of_iso3 <- ifelse(iso3 %in% concerned_ctries, iso3,
  ifelse(iso3 %in% areas_elaborate[[1]], names(areas_elaborate)[1],
         ifelse(iso3 %in% areas_elaborate[[2]], names(areas_elaborate)[2],
                ifelse(iso3 %in% areas_elaborate[[3]], names(areas_elaborate)[3],
                       ifelse(iso3 %in% areas_elaborate[[4]], names(areas_elaborate)[4],
                              ifelse(iso3 %in% areas_elaborate[[5]], names(areas_elaborate)[5],
                                     ifelse(iso3 %in% areas_elaborate[[6]],names(areas_elaborate)[6],NA)))))))
  return(area_of_iso3)
}


## prepare mig between area data 
data1 <- mig.stock.orig.dest |> ungroup() |>
  filter(year == 2020 & dest.area.id < 900 & orig.area.id < 900) |>
  mutate(dest = area_switch(dest.iso3), 
         orig = ifelse(is.na(orig.iso3),'Other',area_switch(orig.iso3))) |>
  filter(!is.na(dest) & !is.na(orig))|>
  filter(dest == country | orig == country) |>
  group_by(orig,dest)|>
  summarise(pop = sum(pop.mig,na.rm = T)/1000, .groups='drop')|>
  mutate(orig = factor(orig,levels = c(concerned_ctries,names(areas_elaborate),'Other')))|>
  arrange(orig) |>
  left_join(wpp.location |> select(iso3,orig.area = area), by = c('orig' = 'iso3')) |>
  left_join(wpp.location |> select(iso3,dest.area = area), by = c('dest' = 'iso3')) |> 
  mutate(orig.area.diagram = ifelse(nchar(orig) == 3, split_10(orig.area),orig), dest.area.diagram = ifelse(nchar(dest) == 3, split_10(dest.area),dest)) 
  

emi.df <-  data1 |> filter(orig == country, dest %in% concerned_ctries) |>
  arrange(desc(pop)) |> top_n(3,pop) |> 
  mutate(dest = paste0('To ',dest.area), pop = format(round(pop),big.mark = ' ',scientific = F)) |> 
  select(!!as.name(paste0('Top 3 emigration corridors from ', country.wpp.name)) := dest,
         'Migrants (thousand)' = pop) |>
  kable(align = c('l','r'))|> kable_classic(full_width = T) |>
  column_spec(1, bold = T, border_right = T,width = '12cm')

immi.df <-  data1 |> filter(dest == country, orig %in% concerned_ctries) |> 
  arrange(desc(pop)) |> top_n(3,pop) |> 
  mutate(dest = paste0('From ',orig.area), pop = format(round(pop),big.mark = ' ',scientific = F)) |>
  select(!!as.name(paste0('Top 3 immigration corridors to ', country.wpp.name)) := dest,
         'Migrants (thousand)' = pop) |>
  kable(align = c('l','r'))|> kable_classic(full_width = T) |>
  column_spec(1, bold = T, border_right = T,width = '12cm')

emi.df
immi.df

```  

<font size = 1><em>***Source:*** United Nations, Department of Economic and Social Affairs, Population Division, 2021. Trends in International Migrant Stock: Migrants by Age and Sex.</em></font> 

  
The chart below shows the major migration corridors from and to `r country.wpp.name`. The light blue arrows show where emigrants from `r country.wpp.name` settled and the dark blue arrows show where immigrants in `r country.wpp.name` came from. The width of the arrow represents the number of migrants.

<center>

<font size = 3> **International immigration and emigration corridors (migrant stock in thousands)<br>`r country.wpp.name`, 2020 ** </em></font>  

</center>  


```{r, fig.align = "center", out.width = "150%"}
# parameters
circos.clear()
circos.par(start.degree = 90, canvas.ylim = c(-1.1,1.1), gap.degree = 4, track.margin = c(-0.1, 0.1), points.overflow.warning = FALSE)
par(mar = rep(1, 4))

# color palette
# colfunc <- colorRampPalette(c('#0083CF', "white"))
# 
# mycolor <- colfunc(length(concerned_ctries)+6)
#mycolor <- mycolor[sample(1:(length(concerned_ctries)+6))]

# Base plot
chordDiagram(
  x = data1 |> select(orig.area.diagram,dest.area.diagram,pop), 
  grid.col = c(unicef_colors_bin[1], rep(unicef_colors_bin[2],length(union(data1|>distinct(orig)|> pull(),data1|>distinct(dest)|> pull()))-1)),
  transparency = 0.25,
  directional = 1,
  direction.type = c("arrows", "diffHeight"), 
  diffHeight  = -0.04,
  annotationTrack = "grid", 
  annotationTrackHeight = c(0.05, 0.1),
  link.arr.type = "big.arrow", 
  link.sort = TRUE, 
  link.largest.ontop = TRUE)

circos.trackPlotRegion(
  track.index = 1, 
  bg.border = NA, 
  panel.fun = function(x, y) {
    
    xlim = get.cell.meta.data("xlim")
    sector.index = get.cell.meta.data("sector.index")
    
    # Add names to the sector. 
    circos.text(
      x = mean(xlim), 
      y = 5, 
      labels = sector.index, 
      facing = "downward",
      niceFacing = T,
      cex = 0.4
    )
    
    # Add graduation on axis
    circos.axis(
      h = "top", 
      major.at = NULL,
      minor.ticks = 1, 
      major.tick.length = 0.5,
      labels.niceFacing = TRUE,
      labels.cex = 0.4)
  }
)
```  
  
<font size = 1><em>***Source:*** United Nations, Department of Economic and Social Affairs, Population Division, 2021. Trends in International Migrant Stock: Migrants by Age and Sex.</em></font> 




### Missing Migrants 
The International Organization for Migration (IOM)’s [Missing Migrants Project](https://missingmigrants.iom.int/) (MMP) records incidents in which migrants, including refugees and asylum-seekers, have died at state borders or in the process of migrating to an international destination. It includes migrants who have died at the external borders of states, or in the process of migration towards an international destination, regardless of their legal status. The Project records only those migrants who die during their journey to a country different from their country of residence.

Each incident of the MMP was assigned a country based on the location coordinates of the incident, including its location within country boundaries such as land and marine economic exclusive zones. The location coordinates pertain to where the death(s) occurred or where the body or bodies were discovered, although in some regions like the Mediterranean, the geographic coordinates are estimated due to imprecise information.


```{r,fig.align = "center",out.width="100%", warning=FALSE}
dt_mmg_ctr <- Missing_Migrants_Global_Figures_allData_withCountries |> 
  filter(ISO_TER1 == country) |> #country iso code from coordinates
  group_by(`Incident year`, `Cause of Death`) |>
  summarise(pop = sum(`Number of Dead`), .groups='drop')
```

`r if(nrow(dt_mmg_ctr) != 0) {"<center>  
<font size = 3>**Missing migrant incidents by cause of death, 2014-2023**</font></center>  "} else {
" **No mortality incidents reported for this country**"}`

```{r,fig.align = "center",out.width="100%", warning=FALSE}
if(nrow(dt_mmg_ctr) != 0){
  fig.mmg <- ggplot(data =dt_mmg_ctr, aes(x = `Incident year`, y = pop, fill = `Cause of Death`)) + 
    geom_bar(stat = 'identity', position = 'stack', alpha = 0.8) +
    labs(#subtitle = country.wpp.name,
      color = NULL,
      y = 'Deaths',x = NULL)+
    scale_fill_manual(values = unicef_colors_tri)+
    scale_x_discrete(drop=FALSE)+  #to show all years,  even those without data
    theme_minimal()+
    theme(legend.position="bottom", 
          legend.text = element_text(size=8), 
          panel.border = element_blank(),
          panel.grid=element_blank(),
          plot.title=element_text(size=14, face="bold"),
          panel.grid.major.y = element_line(color=unicef_colors[9], linetype = "dashed"))+
    guides(fill=guide_legend(ncol = 1))
  fig.mmg
}

```

<font size = 1><em>***Source:*** IOM, 2023. Missing Migrants Protect, https://missingmigrants.iom.int/downloads. Accessed April 2023.

***Note:*** 2023 numbers are preliminary. The count excludes deaths that occur in immigration detention facilities or after deportation to a migrant’s homeland, as well as deaths more loosely connected with migrants´ irregular status, such as those resulting from labour exploitation. Migrants who die or go missing after they are established in a new home are also not included in the data, so deaths in refugee camps or housing are excluded.  The deaths of internally displaced persons who die within their country of origin are also excluded. </em></font>


### Refugees 
**Refugees** are persons who are unable or unwilling to return to their country of origin owing to a well-founded fear of being persecuted for reasons of race, religion, nationality, membership of a particular social group, or political opinion ([1951 Refugee Convention](https://www.unhcr.org/3b66c2aa10.html)).

Refugees are people who have fled war, violence, conflict or persecution and have crossed an international border to find safety in another country.

The term refugee excludes asylum-seekers: persons who have left their country and are seeking protection from persecution and serious human rights violations in another country, but who haven't yet been legally recognized as refugees and are waiting to receive a decision on their asylum claim. 


```{r}
kable(dt_ref, align = c('l',rep('r',3))) |> kable_classic(full_width = T) |>
  column_spec(1, bold = T, border_right = T,width = '12cm') |>
  row_spec(1:9) |>
  add_header_above(myHeader) |>   row_spec( 0, extra_css = "border-top: 1px solid white")
```  



#### UNHCR data on education 

UNHCR has annual report on enrollment of refugees in education. Measuring school enrollment for refugee children is important to understand: access to education, integration, future opportunities and social and economic development of individuals and communities.
```{r}
flag_UNHCR_edu <- all(!is.na(dt_ref_edu_2019$`2019`))
```

```{r}
if(flag_UNHCR_edu){kable(dt_ref_edu_2019, align = c('l','r')) |> kable_classic(full_width = T) |>
  column_spec(1, bold = T, border_right = T,width = '12cm') |>
  row_spec(1:6) |>
  add_header_above(myHeader[1:2]) |>   row_spec( 0, extra_css = "border-top: 1px solid white")}
```

`r if(flag_UNHCR_edu){"<center><font size = 3> **School enrollment rates of refugees and national population by education level,<+br> latest data available** </em></font> </center>   "}`

```{r, fig.align = "center", warning=FALSE}
if(flag_UNHCR_edu){
data_enrlmnt_cmpr <- data.frame(type = c(rep('Refugees',3),rep('Population',3)), 
                                level = c('Pre-primary','Primary','Secondary','Pre-primary','Primary','Secondary') ) |>
  left_join( uis |> filter(LOCATION== country, EDULIT_IND %in% c('GER_1','GER_02','GER_2T3')) |>
               group_by(EDULIT_IND) |> 
               top_n(1, Time) |>
               ungroup()|> 
               mutate(indicator =  recode(EDULIT_IND,'GER_1' = 'Primary','GER_02' = 'Pre-primary', 'GER_2T3' = 'Secondary'),
                      type = 'Population')|>
               select(level = indicator ,rate=Value,type,year = Time), by = c('type','level'))

data_enrlmnt_cmpr[1:3,3:4] <- ref.uis.df |> 
  select(year,'Pre-primary' = `Gross enrollment rate (pre-primary) (%)`,
         Primary = `Gross enrollment rate (primary) (%)`,
         Secondary = `Gross enrollment rate (secondary) (%)`)|>
  gather(level,rate,2:4) |>
  mutate(type = 'Refugees', year = '2019') |> 
  select(rate,year)

data_enrlmnt_cmpr <- mutate(data_enrlmnt_cmpr, 
                            fill = ifelse(is.na(rate),'No data',paste0(type,', ',year))) |>
  mutate(color = ifelse(is.na(rate),'white',ifelse(type == 'Refugees', unicef_colors_bin[1],unicef_colors_bin[2])))

fig_enrlmnt_cmpr <- ggplot(data_enrlmnt_cmpr, aes(x = level,y = rate, fill = color, label = paste0(round(rate,1),"%")))+
  geom_bar(stat = 'identity',position = 'dodge', alpha = 0.7)+
  geom_text(size = 4, position = position_dodge(width = 1),vjust = -0.5)+
  blank_theme +
  labs(fill = NULL)+
  ylab('Per cent')+
  scale_fill_manual(labels = c('No data','Refugees, 2019',data_enrlmnt_cmpr |> filter(type == 'Population' & !is.na(rate)) |> distinct(fill) |> pull()),
                    values = c('white',unicef_colors_bin[1],data_enrlmnt_cmpr |> filter(type == 'Population'& !is.na(rate)) |> distinct(color) |> pull()),
                    limits = c('white',unicef_colors_bin[1],data_enrlmnt_cmpr |> filter(type == 'Population' & !is.na(rate)) |> distinct(color) |> pull()),
                    guide = "legend",drop = FALSE)+
  theme(plot.title = element_text(size=10,face="bold"),
        plot.subtitle = element_text(size = 9),
        legend.key = element_rect(fill = NA, color = unicef_colors[11]),
        panel.grid.major.y = element_line(color=unicef_colors[9], linetype = "dashed"))

fig_enrlmnt_cmpr}
```
`r if(flag_UNHCR_edu){"<font size = 1><em>***Source:*** UNHCR, 2021. Global Trends: Forced Displacement in 2020. UNHCR, 2020. Coming Together For Refugee Education. Education Report 2020. UNESCO, Institute for Statistics, 2020. UIS database, http://data.uis.unesco.org.</em></font>"}`


`r if(!flag_UNHCR_edu){"<font size = 1><em>***Note:*** Currently no data for this indicator for this country. </em></font>"}`



#### UNHCR data on digital connectivity

Mobile cellular coverage is important in digital connectivity as it allows people to stay connected, access information and services, and participate in the digital economy. In areas with limited or no mobile network coverage, people may face barriers to accessing critical services such as healthcare, education, and emergency services and participating in social, economic, and political activities.

```{r}
if(country.wpp.name %in% dcr.ctry.ref$country){
  country.unhcr.sub <- dcr.ctry.ref |> filter(country == country.wpp.name) |> pull(unhcr.subregion)
  
  dt10 <- dcr.df |> filter(area %in% c(country.wpp.name, country.unhcr.sub, 'WORLD')) |> 
    mutate(area = paste0('2014 ',area),pct.2gplus = 100- pct.nocov) |>
    select(area, "Percentage of refugees living in areas with mobile cellular coverage (at least 2G) (%)" = pct.2gplus) |>
    pivot_longer(-area) |>
    pivot_wider(names_from=area, values_from=value) |> 
    rename(Indicator = name, '2014 World' = `2014 WORLD`)
  
  kable(dt10, align = c('l',rep('r',3))) |> kable_classic(full_width = T) |>
    column_spec(1, bold = T, border_right = T,width = '12cm')
}

```


`r if(country.wpp.name %in% dcr.ctry.ref$country){"<font size = 1> <em>***Source:*** UNCHR, 2016. Connecting Refugees. https://www.unhcr.org/publications/operations/5770d43c4/connecting-refugees.html. <br> ***Note:*** The estimation of connectivity for refugees was based on UNHCR 2014 data on the demographic composition and major locations of refugees and individuals in refugee-like situations, in addition to mobile network coverage data. </em></font>"}`


`r if(!(country.wpp.name %in% dcr.ctry.ref$country)){"<font size = 1><em>***Note:*** Currently no data for this indicator for this country. </em></font>"}`


`r if(country %in% c('JOR','SYR','LBN','PSE')){"

### UNRWA Registered Refugees

UNRWA registered **Palestine Refugees** are persons whose normal place of residence was Palestine during the period 1 June 1946 to 15 May 1948, and who lost both home and means of livelihood as a result of the 1948 conflict. Palestine Refugees, and descendants of Palestine refugee males, including legally adopted children, are eligible to register for UNRWA services.

The data shown here does not include other UNRWA persons of concern, such as Non-Refugee Wives, Non-Refugee Husbands, Non-Refugee Children, Frontier Villages, Jerusalem Poor, Gaza Poor and Compromise cases.

Data up to December 2022.

"}`

```{r}
#country <- "JOR"
#country.wpp.name <- "Jordan"
if(country %in% c('JOR','SYR','LBN','PSE')){
  unrwa.ref.world <- UNRWA2022_Q4 |> 
    group_by(sex) |> 
    summarise(Total =round(sum(refugees)/1000),
              `0-17` =round(sum(refugees[age== "0-17"])/1000),
              .groups='drop') |> 
    pivot_longer(cols=2:3,names_to="Age Group", values_to="World") 

  dt <- UNRWA2022_Q4 |> 
    filter(iso3 == country) |> 
    group_by(sex) |> 
    summarise(Total =round(sum(refugees)/1000),
              `0-17` =round(sum(refugees[age == "0-17"])/1000),
              .groups='drop')  |> 
    pivot_longer(cols=2:3,names_to="Age Group", values_to=country.wpp.name) |> 
    left_join(unrwa.ref.world, by=c("Age Group", "sex")) |> 
    arrange(`Age Group`) |> select(c(2,1,3,4))
  
  dt$`Age Group` <- c("UNRWA refugees under age 18 (thousand)", 
                      "",
                      "UNRWA refugees (thousand)",
                      "")
    
  names(dt) <- c('','Sex','2022','2022')
  Header2 <- c(" " = 1, " " = 1, country.wpp.name = 1,'World' = 1)
  names(Header2) <- c(" ", " ", country.wpp.name,'World')
  
  #printing table
  kable(dt, align = c('l','l','r','r')) |> kable_classic(full_width = T) |>
    column_spec(1, bold = T,width = '12cm') |>
    column_spec(2, border_right = T,width = '12cm') |>
    add_header_above(Header2) |>   row_spec( 0, extra_css = "border-top: 1px solid white")
}
```



`r if(country %in% c('JOR','SYR','LBN','PSE')){"<font size = 1><em> ***Source*** UNRWA, 2023. UNRWA Registered Population Dashboard, https://www.unrwa.org/what-we-do/relief-and-social-services/unrwa-registered-population-dashboard. Accessed on 14/4/2023 </em></font>  "}`

### Internally displaced persons
**Internally Displaced Persons (IDPs)** are “Persons or groups of persons who have been forced or obliged to flee or to leave their homes or places of habitual residence, in particular as a result of or in order to avoid the effects of armed conflict, situations of generalized violence, violations of human rights or natural or human-made disasters, and who have not crossed an internationally recognized State border” ([UN Guiding Principles on Internal Displacement](https://www.unhcr.org/43ce1cff2.pdf)).

The [Internal Displacement Monitoring Centre (IDMC)](https://www.internal-displacement.org/) estimates the total number of IDPs at the end of the year by verifying and triangulating data from variety of sources such as national and international organizations, governments, media reports, and other publicly available sources.

<br/>

```{r}
kable(dt_idp[1:6,],  align = c('l',rep('r',3)) ) |> kable_classic(full_width = T) |>
  column_spec(1, bold = T, border_right = T,width = '12cm') |>
  row_spec(1:6)|>
  row_spec(1, extra_latex_after = "\\arrayrulecolor{white}") |>
  add_header_above(myHeader) |>
  row_spec( 0, extra_css = "border-top: 1px solid white")
```


```{r}
data.idp <- idmc.conf.dis.2022 |> filter(year == 2022, iso3 == country) |>
  select( idp.conf.new,idp.dis.new, idp.conf.stock,idp.dis.stock)|> 
  mutate_all(~ifelse(is.na(.),0,.)) |> 
  gather(key = type, value = pop,1:4) |>
  mutate(disp.type = ifelse(grepl('new',type),'New displacements','Internally displaced persons'),
         type = ifelse(grepl('conf',type),'Conflict','Disaster')) |> 
  group_by(disp.type) |>
  mutate(pop = scale_round_k(pop),
         width = sum(pop, na.rm = T),
         pct = paste0(round(pop/sum(pop)*100),'%'),
         ypos = cumsum(pop/sum(pop))- 0.5*pop/sum(pop)) |>
  mutate(fraction = pop/sum(pop), ymax = cumsum(fraction), ymin = c(0, head(ymax, n=-1))) |> 
  ungroup()|>
  mutate(type = factor(type, levels = unique(as.character(type)))) |>
  mutate(disp.type = factor(disp.type, levels = c('Internally displaced persons', 'New displacements')))

data.adet <- idmc.disaster.2022 |> filter(iso3 == country) |> 
  mutate(start.date = as.Date(start.date),
         idp.dis.new = scale_round_k(idp.dis.new))

data.adet$hazard.cat <- factor(data.adet$hazard.cat, levels=c("Weather related","Geophysical","Unknown"))

```


`r if(nrow(data.idp) > 0){"
<center><font size = 3>**Number of internally displaced persons and new displacements<br> by hazard category in 2022 (in thousands)**</font></center>
"} else {"
**No IDP data for this country **
"}`


```{r, fig.align = "center",out.width="100%"}
#, fig.show="hold"
if(nrow(data.idp) > 0){
  fig.idp <-  ggplot(data.idp, aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3, fill=type)) +
    geom_rect() +
    geom_text( x=2, aes(y= ypos, label=paste0(pop,'\n',pct), color=type), size=3) +
    coord_polar(theta="y") +
    xlim(c(-1, 4)) +
    facet_wrap('disp.type')+
    scale_fill_manual(name = NULL, labels = c('Conflict-related','Disaster-related'),values = c(unicef_colors[1], unicef_colors[2]))+
    scale_color_manual(name = NULL, labels = c('Conflict-related','Disaster-related'),values = c(unicef_colors[1],unicef_colors[2]))+
    labs(fill = NULL)+
    theme(axis.line=element_blank(),
          axis.text.y=element_blank(),
          axis.text.x=element_blank(),
          axis.ticks=element_blank(),
          axis.title.y=element_blank(),
          axis.title.x=element_blank(),
          panel.background=element_blank(),
          panel.border=element_blank(),
          panel.grid.major=element_blank(),
          panel.grid.minor=element_blank(),
          plot.background=element_blank(),
          aspect.ratio = 1,
          legend.position = "bottom")
  
  fig.idp
}

```

`r if(nrow(data.idp) > 0){"
<center><font size = 3>**Number of new IDPs from disaster events by hazard category<br>2008-2022 (in thousands)**</font></center>
"}`


```{r, fig.align = "center",out.width="100%"}
#, fig.show="hold"
if(nrow(data.idp) > 0){
  fig.adet <-  ggplot(data = data.adet, aes(x = start.date, y = idp.dis.new, size = idp.dis.new, color = hazard.cat)) +
    geom_point() +
    scale_color_manual(name = NULL, labels = c('Geophysical','Weather related', 'Unknown'),values = unicef_colors[c(2,4,5)])+
    labs(color = NULL,
         y = 'New persons displaced',x = NULL)+
    scale_x_date(breaks = as.Date(paste0(seq(2008,2023,2), "-01-01")),
                 labels=seq(2008,2023,2))+
    theme_minimal()+
    theme(legend.position = "bottom",
          panel.grid.minor = element_blank())+
    guides(size = "none")
  
  fig.adet
}

```

`r if(nrow(data.idp) > 0){" <font size = 1><em>***Source:*** IDMC, 2023. Global Internal Displacement Database.</em></font> <br>
"}`


```{r,fig.align = "center",eval=F}
data3 <- rbind(unhcr.gt.tab12.new |> 
                 filter(iso3 == country, pop.type == 	'Refugees') |> 
                 select(pop = pop.ref.asy, pop_child = pop.ref.0to17.asy,
                        pop_child_share = prop.ref.0to17.asy) |> 
                 mutate(type = paste0('Refugees in \n', country)),
               unhcr.gt.tab13.new |> 
                 filter(iso3 == country, pop.type == 	'Refugees') |> 
                 select(pop = pop.ref.orig, pop_child = pop.ref.0to17.orig,
                        pop_child_share = prop.ref.0to17.orig) |> 
                 mutate(type = paste0('Refugees from \n', country)),
               idmc.conf.dis.2022 |> 
                 filter(year == 2022, iso3 == country) |> 
                 select(pop = idp.conf.stock,
                        pop_child = idp.conf.stock.0to17) |> 
                 mutate(pop_child_share = pop_child/pop, type = 'Conflict related\nIDPs' ),
               idmc.conf.dis.2022 |> 
                 filter(year == 2022, iso3 == country) |> 
                 select(pop = idp.dis.stock, 
                        pop_child = idp.dis.stock.0to17) |> 
                 mutate(pop_child_share = pop_child/pop, type = 'Disaster related\nIDPs' )) |>
  mutate(pop_18plus = ifelse(is.na(pop_child),pop,pop-pop_child))|>
  gather(key = pop.type, value = population,c(2,5)) |>
  mutate(pop.type = ifelse(is.na(pop_child_share) &  grepl("Refugees",type), 'Population (without disaggregation by age)', pop.type) ,
         pop.type = factor(pop.type,levels = c('pop_18plus','pop_child','Population (without disaggregation by age)'), labels = c('Population 18 plus', 'Population under 18','Population (without disaggregation by age)')),
         pop_child_share = ifelse(pop.type == 'Population 18 plus'&!is.na(pop_child_share),1-pop_child_share,pop_child_share),
         label = ifelse(is.na(pop) & is.na(pop_child_share),'No data', paste0(round(population/1000,1),' (',ifelse(is.na(pop_child_share), 100,round(pop_child_share*100,1)),'%)'))) |> distinct(type,label, .keep_all = TRUE)

if(data3 |> distinct(pop.type) |> nrow() == 2){
   colors <- c("Population 18 plus" = unicef_colors_bin[1],
               "Population under 18" = unicef_colors_bin[2])
   fig3 <- ggplot(data3,aes(x = as.factor(type), 
                            y = population/1000,
                            fill = pop.type,label = paste0(round(population/1000,1),' (',round(pop_child_share*100,1),'%)')))+
  geom_bar(stat='identity',position = 'stack',alpha =0.7)+
  geom_text_repel(data = data3 |> filter(pop.type != 'Population (without disaggregation by age)'),aes(y = ifelse(label == 'No data',0,population/1000)), size = 3,position = position_stack(vjust = 0.5)) +
  scale_fill_manual(values = colors)+
  labs(
    y = 'Population (thousand)',
    x = 'Year',
    title = "Displaced persons population by age and type of displacement",
    subtitle = paste0(name_of_country,', 2022'),
    fill = NULL)+
  blank_theme+
  theme(axis.text.x = element_text(angle = 15))
} else {
  colors <- c("Population 18 plus" = unicef_colors_bin[2], "Population under 18" = unicef_colors_bin[1],'Population (without disaggregation by age)' = unicef_colors[10])
  fig3 <- ggplot(data3,aes(x = as.factor(type), y = population/1000,fill = pop.type,label = label))+
  geom_bar(stat='identity',position = 'stack',alpha =0.7)+
  geom_text_repel(data = data3 |> filter(pop.type != 'Population (without disaggregation by age)'),aes(y = ifelse(label == 'No data',0,population/1000)), size = 3,position = position_stack(vjust = 0.5)) +
  geom_text(data = data3 |> filter(pop.type == 'Population (without disaggregation by age)' &  !is.na(population) ),aes(y = population/1000), size = 3,position = position_stack(vjust = 0.5)) +
 # geom_text(data = data3 |> filter(pop.type == "Population 18 plus"),aes(y = pop/1000, label = round(pop/1000)), size = 3, nudge_y = 5 ) +
  scale_fill_manual(values = colors)+
  labs(
    y = 'Population (thousand)',
    x = 'Year',
    title = "Displaced persons population by age and type of displacement",
    subtitle = paste0(name_of_country,', 2022'),
    fill = NULL)+
  blank_theme+
  theme(axis.text.x = element_text(angle = 15))
}

fig3
```

### Remittances 
Foreign remittance is a transfer of money from a foreign worker to their family or other individuals in their home countries. In some countries, remittances may constitute a significant portion of the nation's GDP.

The World Bank provides annual estimates of remittances flows globally (and bilaterally), based on national balance of payment statistics produced by central Banks and compiled by the IMF

```{r}
kable(dt_remit_2021, align = c('l',rep('r',3))) |> kable_classic(full_width = T) |>
  column_spec(1, bold = T, border_right = T,width = '12cm') |>
  row_spec(1:2) |>
  add_header_above(myHeader) |>   row_spec( 0, extra_css = "border-top: 1px solid white")
```

<font size = 1><em>***Source:*** World Bank, 2022. World Bank database, https://data.worldbank.org. </em></font>

-------

## Section 2: National Demographics and socio-economics

-------

In this section, we provide an overview of the country's key demographic and socio-economic indicators. This includes data on population size and growth, age distribution, income and poverty rates, educational attainment, and other important factors that impact the well-being and quality of life of individuals and communities across the country.


#### Population numbers

```{r}
if(country.wpp.name == "New Zealand"){
  pop.df$year[pop.df$year=="2022 Australia/New Zealand"] <- "2022 Aus/NZ"
  }

dt1 <- pop.df |>
  select(1:8) |>
  pivot_longer(-year) |>
  pivot_wider(names_from=year, values_from=value) |>
  select(name, ends_with(country.wpp.name,ignore.case = F))|>
  select('Indicator' = name, '2000' = starts_with('2000'),'2022' = starts_with('2022'), '2050*' = starts_with('2050')) |>
  mutate_if(is.numeric, ~ifelse(. < 1,'<1',format( round(.),big.mark = ' ')))

# create vector with colspan
myHeader <- c(" " = 1, country.wpp.name = 3)
names(myHeader) <- c(" ", country.wpp.name)

kable(dt1,align = c('l',rep('r',3)))  |> kable_classic(full_width = T) |>
  column_spec(1, bold = T, border_right = T,width = '12cm',) |>
  add_header_above(myHeader) |>   row_spec( 0, extra_css = "border-top: 1px solid white") |>
  footnote(symbol = 'projected')

```


<center>

<font size = 3> **Population by age group<br>`r country.wpp.name`, `r yr_bg1`-`r yr_ed1` ** </em></font>  

</center>  

```{r, message=F,warning=F,fig.align = "center"}
data_chart1 <- wpp.age.group |> filter(iso3 == country & year %in% yr_bg1:yr_ed1) |>
  select(1:3,pop0to4.thsd, pop0to17.thsd,pop17plus.thsd,pop60plus.thsd) |>
  mutate(pop5to17.thsd = pop0to17.thsd-pop0to4.thsd, pop18to59.thsd = pop17plus.thsd-pop60plus.thsd,  datatype = ifelse(year>=2022,'Projection','Estimation')) |>
  select(1:3, pop0to4.thsd, pop5to17.thsd,pop18to59.thsd,pop60plus.thsd,datatype) |>
  mutate_at(.vars = 4:7,~round(.,1))|>
  gather(key = 'age group', value = 'population',4:7) |>
  mutate(`age group` = factor(`age group`, levels = rev(c('pop0to4.thsd', 'pop5to17.thsd','pop18to59.thsd','pop60plus.thsd')), labels =c('Adults 60+','Adults 18-59','Children 5-17','Children under 5')))

fig_chart1 <-ggplot(data_chart1, aes(x = year,y = population/1000, fill = `age group`,alpha = datatype))+
  geom_area()+
  geom_vline(xintercept = 2021.5, linetype="dashed",
                color = unicef_colors[10], size=0.5)+
#  annotate(geom = 'text', label = '2022', x = 2019.5, y = Inf,size = 2, color = unicef_colors[10], hjust = 1.5, vjust = 3)+
  scale_fill_manual(name = NULL, values = c(unicef_colors[9], unicef_colors[10], unicef_colors_bin[1], unicef_colors_bin[2]))+
  scale_x_continuous(breaks = c(1950 ,1975 ,2000 ,2022, 2050),labels = c('1950' ,'1975' ,'2000' ,'2022', '2050'))+
  scale_alpha_discrete(name = NULL,range = c(1,0.3))+
  labs(y = 'Population (million)',
       x = 'Year',
       fill = NULL)+
  guides(alpha="none") + geom_text(x=2035, y=0, label="Projection",color=unicef_colors[9])+
  blank_theme+
  theme(legend.position="bottom",
        legend.direction="vertical",
        plot.title=element_text(size=14, face="bold"),
        panel.grid.major.y = element_line(color=unicef_colors[9], linetype = "dashed"))

fig_chart1

```

<font size = 1><em>***Source:*** United Nations, Department of Economic and Social Affairs, Population Division, 2019. World Population Prospects: The 2019 Revision.</em></font>

#### Share of population
```{r}
dt2 <- pop.df |>
  select(1,10:13,9) |>
  pivot_longer(-year) |>
  pivot_wider(names_from=year, values_from=value) |>
  select(name, ends_with(country.wpp.name),ends_with(country.wpp.sub),everything())

colnames(dt2) <- c('Indicator', '2000' ,'2022' , '2050*' , '2022', '2022')

# create vector with colspan
myHeader <- c(" " = 1, country.wpp.name = 3,country.wpp.sub = 1,'World' = 1)
names(myHeader) <- c(" ", country.wpp.name,country.wpp.sub,'World')

kable(dt2)  |> kable_classic(full_width = T) |>
  column_spec(1, bold = T, border_right = T,width = '12cm') |>
  add_header_above(myHeader) |>   row_spec( 0, extra_css = "border-top: 1px solid white")|>
  footnote(symbol = 'projected')

```

<center>

<font size = 3> **Left: Share of population by age group, `r yr_bg1`-`r yr_ed1`<br>Right: Age Pyramid, 2022 and 2050<br>`r country.wpp.name`** </em></font>  

</center> 

```{r, message=F,warning=F,out.width="50%"}
data_chart2 <- wpp.age.group.pct |> filter(iso3 == country & year %in% yr_bg1:yr_ed1) |>
  select(1:3,pop0to4.pct, pop0to17.pct,pop17plus.pct,pop60plus.pct) |>
  mutate(pop5to17.pct = pop0to17.pct-pop0to4.pct, pop18to59.pct = pop17plus.pct-pop60plus.pct,  datatype = ifelse(year>=2022,'Projection','Estimation')) |>
  select(1:3, pop0to4.pct, pop5to17.pct,pop18to59.pct,pop60plus.pct,datatype) |>
  mutate_at(.vars = 4:7,~round(.,1))|>
  gather(key = 'age group', value = 'population',4:7) |>
  mutate(`age group` = factor(`age group`, levels = rev(c('pop0to4.pct', 'pop5to17.pct','pop18to59.pct','pop60plus.pct')), labels =c('Adults 60+','Adults 18-59','Children 5-17','Children under 5')))

fig_chart2 <-ggplot(data_chart2, aes(x = year,y = population, fill = `age group`,alpha = datatype))+
  geom_area()+
  geom_vline(xintercept = 2021.5, linetype="dashed",
                color = unicef_colors[10], size=0.5)+
#  annotate(geom = 'text', label = '2022', x = 2019.5, y = Inf,size = 2, color = unicef_colors[10], hjust = 1.5, vjust = 3)+
  scale_fill_manual(name = NULL, values = c(unicef_colors[9], unicef_colors[10], unicef_colors_bin[1], unicef_colors_bin[2]))+
  scale_x_continuous(breaks = c(1950 ,1975 ,2000 ,2022, 2050),labels = c('1950' ,'1975' ,'2000' ,'2022', '2050'))+
  scale_alpha_discrete(name = NULL,range = c(1,0.7))+
  guides(alpha="none") + geom_text(x=2035, y=0, label="Projection",color=unicef_colors[9])+
  labs(y = 'Share (%)',
       x = 'Year',
       fill = NULL)+
  blank_theme+
  theme(legend.position="bottom",
        legend.direction="vertical",
        plot.title=element_text(size=14, face="bold"),
        panel.grid.major.y = element_line(color=unicef_colors[9], linetype = "dashed"))

#Age pyramids figure

pop.male <- wpp.age.group.male |> filter(iso3 == country, year == 2022) |> pull(poptotal.thsd) *1000
pop.female <- wpp.age.group.female |> filter(iso3 == country, year == 2022) |> pull(poptotal.thsd) *1000

age_pyramid_female <- wpp.5y.age.group.female |> 
  filter(area.id == id_of_country, year %in% c(2022,2050)) |>
  select(year,5:25) |>
  #mutate(pop75plus.thsd = pop75to79.thsd+pop80to84.thsd+pop85to89.thsd+pop90to94.thsd+pop95to99.thsd+pop100plus.thsd) |>
  #select(1:15, pop75plus.thsd) |> 
  gather(key = 'age.group', value = 'pop',-1) |> 
  mutate(age.group = str_replace(age.group,'pop',''),
         age.group = str_replace(age.group,'.thsd',''),
         age.group = str_replace(age.group,'to','-'),
         age.group = str_replace(age.group,'plus','+'),
         pop = pop*1000, sex = 'Female') |>
  select(age.group,pop,sex,year)

age_pyramid_male <- wpp.5y.age.group.male |>
  filter(area.id == id_of_country, year %in% c(2022,2050)) |> 
  select(year,5:25) |>
  #mutate(pop75plus.thsd = pop75to79.thsd+pop80to84.thsd+pop85to89.thsd+pop90to94.thsd+pop95to99.thsd+pop100plus.thsd) |>
  #select(1:15, pop75plus.thsd) |> 
  gather(key = 'age.group', value = 'pop',-1) |> 
    mutate(age.group = str_replace(age.group,'pop',''),
         age.group = str_replace(age.group,'.thsd',''),
         age.group = str_replace(age.group,'to','-'),
         age.group = str_replace(age.group,'plus','+'),
         pop = pop*1000, sex = 'Male') |>
  select(age.group,pop,sex,year)

data_chart3 <-  bind_rows(age_pyramid_female,age_pyramid_male) |>
  group_by(year) |> 
  mutate(pct = pop/sum(pop), age.group = factor(age.group,level = unique(age.group)))


fig_chart3 <- ggplot(data=data_chart3,aes(x= age.group, y = pct)) +
  geom_bar(data= data_chart3 |> filter(sex == 'Female', year == 2022),aes(fill = 'Female'), stat = 'identity',alpha = 0.4) +
  geom_bar(data= data_chart3 |> filter(sex == 'Male', year == 2022), aes(y = pct * -1, fill = 'Male'), stat = 'identity', alpha = 0.4) +
  geom_bar(data= data_chart3 |> filter(sex == 'Female', year == 2050), aes(color = 'Female'), stat = 'identity', alpha = 0) +
  geom_bar(data= data_chart3 |> filter(sex == 'Male', year == 2050), aes(y = pct * -1, color = 'Male'), stat = 'identity', alpha = 0) +
  scale_y_continuous(breaks=seq(-0.08,0.08,0.02),labels=paste0(abs(seq(-8,8,2)),'%')) +
  scale_fill_manual(values = unicef_colors)+
  scale_color_manual(values = unicef_colors)+
  coord_flip()+
  blank_theme +
  theme(axis.title.y = element_blank(),legend.position="bottom",legend.direction="vertical",plot.margin=unit(c(0,0,0,1.5), "cm"))+
  labs(fill = '2022',
       color = '2050')+
  guides(fill  = guide_legend(order = 1),
         color = guide_legend(order = 2))

#grid.arrange(fig_chart1, fig_chart2, ncol=2)
fig_chart2
fig_chart3
```

<font size = 1><em>***Source:*** United Nations, Department of Economic and Social Affairs, Population Division, 2019. World Population Prospects: The 2019 Revision.</em></font>

#### Demographics

Demographic data of a country are essential for planning and resource allocation, economic development, tracking health outcomes and social progress.

```{r}
dt3 <- pop.df |>
  select(1,14,18,19,15) |>
  pivot_longer(-year) |>
  pivot_wider(names_from=year, values_from=value) |>
  select(name, ends_with(country.wpp.name),ends_with(country.wpp.sub),everything()) |>
  mutate_if(is.numeric, ~ifelse(name != 'Births (thousand)',format(round(.,1),big.mark = ' '),format(round(.),big.mark = ' ')))

colnames(dt3) <- c('Indicator', '2000' ,'2022' , '2050*' , '2022', '2022')

# create vector with colspan
myHeader <- c(" " = 1, country.wpp.name = 3,country.wpp.sub = 1,'World' = 1)
names(myHeader) <- c(" ", country.wpp.name,country.wpp.sub,'World')


kable(dt3,align = c('l',rep('r',5)))  |> kable_classic(full_width = T) |>
  column_spec(1, bold = T, border_right = T,width = '12cm') |>
  add_header_above(myHeader) |>   row_spec( 0, extra_css = "border-top: 1px solid white")|>
  footnote(symbol = c('projected'))

```

<center>

<font size = 3> **Left: Total fertility rate<br>Right: Number of births<br>`r country.wpp.name`, 1950-2050** </em></font>  

</center> 

```{r, message=F,warning=F,out.width="50%"}
yr_bg2 <- 1950
yr_ed2 <- 2050

data_chart4 <- wpp.dem |> filter(iso3 == country & year %in% yr_bg2:yr_ed2) |> select(year,  tfr) |> 
  mutate(linetype=ifelse(year<2022, "Estimated","Projection"))

fig_chart4 <- ggplot(data_chart4, aes(x = year,y = tfr))+
  geom_line(aes(linetype=linetype),color = unicef_colors[1], size=1.5)+
  geom_vline(xintercept = 2022, linetype="dashed",
             color = unicef_colors[10], size=1)+
  scale_x_continuous(breaks = c(1950 ,1975 ,2000 ,2022, 2050),labels = c('1950' ,'1975' ,'2000' ,'2022', '2050'))+
  labs(title='Total fertility rate',
       #subtitle= paste0(name_of_country, ", ", yr_bg2,"-",yr_ed2),
       y = 'Live births per woman',
       x = 'Year',
       fill = NULL)+
  guides(linetype="none") + geom_text(x=2035, y=0, label="Projection",color=unicef_colors[9])+
  blank_theme+
  ylim(0,NA)+
  theme(legend.position="bottom",legend.direction="vertical",
        plot.title=element_text(size=14, face="bold"),
        panel.grid.major.y = element_line(color=unicef_colors[9], linetype = "dashed"))

data_chart5 <- wpp.dem |> filter(iso3 == country & year %in% yr_bg2:yr_ed2) |> select(year, births.thsd)|> 
  mutate(linetype=ifelse(year<2022, "Estimated","Projection"))

fig_chart5 <- ggplot(data_chart5, aes(x = year,y = births.thsd))+
  geom_line(aes(linetype=linetype),color = unicef_colors[1], size=1.5)+
  geom_vline(xintercept = 2022, linetype="dashed",
                color = unicef_colors[10], size=1)+
  scale_x_continuous(breaks = c(1950 ,1975 ,2000 ,2022, 2050),labels = c('1950' ,'1975' ,'2000' ,'2022', '2050'))+
  labs(title='Number of births',
       #subtitle= paste0(name_of_country, ", ", yr_bg2,"-",yr_ed2),
       y = 'Births (thousand)',
       x = 'Year',
       fill = NULL)+
  guides(linetype="none") + geom_text(x=2035, y=0, label="Projection",color=unicef_colors[9])+
  blank_theme+
  ylim(0,NA)+
  theme(legend.position="bottom",
        legend.direction="vertical",
        plot.title=element_text(size=14, face="bold"),
        panel.grid.major.y = element_line(color=unicef_colors[9], linetype = "dashed"))

fig_chart4
fig_chart5
```

<font size = 1><em>***Source:*** United Nations, Department of Economic and Social Affairs, Population Division, 2022. 2022 Revision of World Population Prospects.</em></font>

### Child mortality indicators

Calculating child mortality indicators is important to monitor progress towards SDGs, identify areas in need and evaluating the effectiveness of interventions. These are also  key components to improve health outcomes for children in a country.


```{r}

latest_year_igme = max(igme$Year)
igme.df <- igme |> mutate_at(.vars = c('Year', 'Median', 'Lower', 'Upper'), as.numeric) |>
  filter(Year %in% c(2000,max(Year)) & ISO.Code == country & Shortind == 'NMR')  |>
  mutate(year = ifelse(Year == 2000,'2000','latest')) |>
  select(year,'Neonatal mortality rate (deaths per 1 000 live births)' = Median) |>
  left_join(igme |>
  filter(Year %in% c(2000,max(Year)) & ISO.Code == country & Shortind == 'IMR') |>
  mutate(year = ifelse(Year == 2000,'2000','latest')) |>
  select(year,'Infant mortality rate (deaths per 1 000 live births)' = Median), by = 'year') |>
  left_join(igme |>
  filter(Year %in% c(2000,max(Year)) & ISO.Code == country & Shortind == 'U5MR') |>
  mutate(year = ifelse(Year == 2000,'2000','latest')) |>
  select(year,'Under-five mortality rate (deaths per 1 000 live births)' = Median), by = 'year') |>
  left_join(igme |>
  filter(Year %in% c(2000,max(Year)) & ISO.Code == country & Shortind == '10q10') |>
  mutate(year = ifelse(Year == 2000,'2000','latest')) |>
  select(year,'Adolescent (10-19 years) mortality rate (deaths per 1 000 live births)' = Median), by = 'year') |>
  mutate_if(is.numeric,~ifelse(year == 'latest',paste0(round(.,1),' (', latest_year_igme,')'),round(.,1)))

dt.igme <- igme.df |>
  pivot_longer(-year) |>
  pivot_wider(names_from=year, values_from=value)

colnames(dt.igme) <- c('Indicator', '2000' ,'Latest')

# create vector with colspan
myHeader <- c(" " = 1, country.wpp.name = 2)
names(myHeader) <- c(" ", country.wpp.name)

if(nrow(dt.igme) == 0){
  flag_igme <- F
}else{
  flag_igme <- T
  kable(dt.igme,align = c('l','r','r'))  |> kable_classic(full_width = T) |>
  column_spec(1, bold = T, border_right = T,width = '12cm') |>
  add_header_above(myHeader) |>   row_spec( 0, extra_css = "border-top: 1px solid white")
}

```
`r if(flag_igme){"<center> <font size = 3> **Child mortality**</font></center> "}`

```{r,fig.align = "center"}
if(!nrow(dt.igme) == 0){
fig_igme <- ggplot(igme |> filter(Year %in% seq(1990,latest_year_igme), ISO.Code == country), aes(x = Year, y = Median, color = Indicator,shape = Indicator)) +
  geom_line(size = 0.8, linetype = "dashed") +
  geom_point(size =2)+
  scale_color_manual(values = c(unicef_colors[9], unicef_colors[10], unicef_colors_bin[1], unicef_colors_bin[2]))+
  blank_theme+
  labs(y = 'Deaths per 1 000 total births')+
  ylim(0,NA)+  #always showing minimum zero
  theme(plot.title = element_text(face = 'bold'),
        panel.grid.major.x = element_line(color=unicef_colors[9], linetype = "dashed"),
        panel.grid.major.y = element_line(color=unicef_colors[9], linetype = "dashed"))

fig_igme
}
```

`r if(flag_igme){"<font size = 1><em>***Source:*** United Nations Inter-agency Group for Child Mortality Estimation (UN IGME) 2022. UN IGME database, https://childmortality.org/.</em></font>"}`

`r if(!flag_igme){"<font size = 1><em>***Note:*** Currently no data for this indicator for this country. </em></font>"}`


### Child protection indicators
Children on the move lacking a birth certificate or identity documentation may be denied access to education or health services, are at risk being treated as an adult, and face an increased risk of family separation and ofobstacles to durable solutions such as integration or relocation. Lacking a birth certificate can also be an obstacle to proving nationalitycitizenship and being considered in the country's vital statistics. 

```{r}
cp.df <- cp.br.under5 |> 
  ungroup() |> 
  filter(iso3 == country) |> 
  mutate('Latest year' = paste0(round(OBS_VALUE.Observation.Value,1),' (',TIME_PERIOD.Time.period,')')) |> 
  select(`Latest year`)

dt9 <- cp.df |> add_column(data.frame("Indicator" = "Percentage of children under age 5 whose births are registered (%)"), .before = 1)

myHeader <- c(" " = 1, country.wpp.name = 1)
names(myHeader) <- c(" ", country.wpp.name)

if(nrow(dt9) != 0){
  kable(dt9,align = c('l','r'))  |> kable_classic(full_width = T) |>
  column_spec(1, bold = T, border_right = T,width = '12cm') |>
  add_header_above(myHeader) |>
  row_spec( 0, extra_css = "border-top: 1px solid white")
}

```

```{r, eval=FALSE, fig.align = "center"}
if(nrow(dt9) != 0){
time_chart9 <- cp.br.under5 |> filter(iso3 == country) |> pull(TIME_PERIOD.Time.period)
data_chart9 <- cp.br.under5 |> filter(iso3 == country) |> select(Registered = OBS_VALUE.Observation.Value) |> mutate(Unregistered = 100- Registered) |> gather(key = 'class', value = 'prop',1:2) |> arrange(desc(class)) |>
  mutate(lab.ypos = cumsum(prop) - 0.5*prop)

fig_chart9 <- ggplot(data_chart9, aes(x = 2, y = prop, fill = class)) +
  geom_bar(stat = "identity", color = "white") +
  coord_polar(theta = "y", start = 0)+
  geom_text(aes(y = lab.ypos, label = paste0(round(prop,1), "%")))+
  scale_fill_manual(values = c(unicef_colors[1], unicef_colors[9]))+
  theme_void()+
  labs(subtitle = paste0(name_of_country,', ',time_chart9),
       fill = NULL)+
  xlim(0.5, 2.5)+
  theme(plot.title = element_text(face = 'bold'))

fig_chart9
}
```

<font size = 1><em>***Source:*** UNICEF, 2022. Data Warehouse, https://data.unicef.org/.</em></font>

### Education indicators

National education indicators are statistics that measure the status and progress of a country's education system. These indicators provide information on the access to and quality of education, as well as the outcomes of education.

```{r}
edu1.df <- uis.sdg.lit.youth |> ungroup() |> filter(country_id == country)
if(nrow(edu1.df) == 1){
  edu1.df <- edu1.df |> mutate('Latest year' = paste0(round(value,1),' (',year,')')) |> select(`Latest year`)
} else {
  edu1.df <- tibble('Latest year' = NA)
}

dt6 <- edu1.df |> add_column(data.frame("Indicator" = "Youth literacy rate (15-24 years)"), .before = 1)

myHeader <- c(" " = 1, country.wpp.name = 1)
names(myHeader) <- c(" ", country.wpp.name)

kable(dt6,align = c('l','r'))  |> kable_classic(full_width = T) |>
  column_spec(1, bold = T, border_right = T,width = '12cm') |>
  add_header_above(myHeader) |>   row_spec( 0, extra_css = "border-top: 1px solid white")

```

```{r}

edu2.df <- data.frame('Education by level' = c('Completion rate  (%)','Net enrolment rate  (%)','Out-of-school rate  (%)','Pupil-trained teacher ratio' ),
                      'Primary' = c(uis.sdg.cr.primary |> ungroup() |> filter(country_id == country) |> mutate('Latest year' = paste0(round(value,1),' (',year,')')) |> pull(`Latest year`) |> pur(),
                                    uis.ner.primary |> ungroup() |> filter(country_id == country) |> mutate('Latest year' = paste0(round(value,1),' (',year,')')) |> pull(`Latest year`) |> pur(),
                                    uis.sdg.oos.primary |> ungroup() |> filter(country_id == country) |> mutate('Latest year' = paste0(round(value,1),' (',year,')')) |> pull(`Latest year`) |> pur(),
                                    uis.sdg.ptr.trained.primary |> ungroup() |> filter(country_id == country) |> mutate('Latest year' = paste0(round(value,1),' (',year,')')) |> pull(`Latest year`) |> pur()),
                      'Lower secondary' = c(uis.sdg.cr.lowersec |> ungroup() |> filter(country_id == country) |> mutate('Latest year' = paste0(round(value,1),' (',year,')')) |> pull(`Latest year`) |> pur(),
                                    uis.ner.lowersec |> ungroup() |> filter(country_id == country) |> mutate('Latest year' = paste0(round(value,1),' (',year,')')) |> pull(`Latest year`) |> pur(),
                                    uis.sdg.oos.lowersec |> ungroup() |> filter(country_id == country) |> mutate('Latest year' = paste0(round(value,1),' (',year,')')) |> pull(`Latest year`) |> pur(),
                                    uis.sdg.ptr.trained.lowersec |> ungroup() |> filter(country_id == country) |> mutate('Latest year' = paste0(round(value,1),' (',year,')')) |> pull(`Latest year`) |> pur()),
                      'Upper secondary' = c(uis.sdg.cr.uppersec |> ungroup() |> filter(country_id == country) |> mutate('Latest year' = paste0(round(value,1),' (',year,')')) |> pull(`Latest year`) |> pur(),
                                    uis.ner.uppersec |> ungroup() |> filter(country_id == country) |> mutate('Latest year' = paste0(round(value,1),' (',year,')')) |> pull(`Latest year`) |> pur(),
                                    uis.sdg.oos.uppersec |> ungroup() |> filter(country_id == country) |> mutate('Latest year' = paste0(round(value,1),' (',year,')')) |> pull(`Latest year`) |> pur(),
                                    uis.sdg.ptr.trained.uppersec |> ungroup() |> filter(country_id == country) |> mutate('Latest year' = paste0(round(value,1),' (',year,')')) |> pull(`Latest year`) |> pur()))

dt7 <- tibble(edu2.df)
colnames(dt7) <- c('Indicator', 'Primary' ,'Lower secondary','Upper secondary')

# create vector with colspan
myHeader <- c(" " = 1, 'latest year' = 3)
names(myHeader) <- c(" ", paste0(name_of_country,", latest year"))


kable(dt7, align = c('l','r','r','r'))  |> kable_classic(full_width = T) |>
  column_spec(1, bold = T, border_right = T,width = '12cm') |>
  add_header_above(myHeader) |>   row_spec( 0, extra_css = "border-top: 1px solid white")
```

<font size = 1><em>***Source:*** UNESCO, Institute for Statistics, 2022. UIS database, http://data.uis.unesco.org.</em></font>

### Labour indicators

```{r}
ilo.df.blank <- tibble(Indicator =c("Adult (25+) unemployment rate (%)", 
                                    "Youth (15-24) unemployment rate (%)",
                                    "Share of youth (15-24) not in employment, education or training (NEET) (%)", 
                                    "Proportion of children engaged in economic activity (%)", 
                                    "Working poverty rate (percentage of employed living below US$1.90 PPP)"),
                       `2000`=rep(NA,5), Latest=rep(NA,5))

wpp.location.area <- wpp.location |> select(iso3,wpp.area = area,wpp.subregion = subregion)

#Adult (25+) unemployment rate (%)
ilo.unemploy.wpp1 <- ilo.unempl.pct.est |>
  left_join(wpp.location.area, by = c('ref_area' = 'iso3'))|>
  filter(sex == 'SEX_T', classif1 == 'AGE_YTHADULT_YGE25', ref_area == country)
v1 <- ilo.unemploy.wpp1 |> filter(time==2000) |> select(obs_value) |> pull()
v2 <- ilo.unemploy.wpp1 |> arrange(time) |> select(obs_value) |> last() |> pull()
v2_time <- ilo.unemploy.wpp1 |> arrange(time) |> select(time) |> last() |> pull()
ilo.df.blank$`2000`[1] <- ifelse(length(v1)==1,paste0(round(v1,1), " (2000)"),NA)
ilo.df.blank$Latest[1] <- ifelse(length(v2)==1,paste0(round(v2,1), " (",v2_time, ")"),NA)

#Youth (15-24) unemployment rate (%)
ilo.unemploy.wpp2 <- ilo.unempl.pct.est |> 
  left_join(wpp.location.area, by = c('ref_area' = 'iso3'))|>
  filter(sex == 'SEX_T', classif1 == 'AGE_YTHADULT_Y15-24', ref_area == country)
v1 <- ilo.unemploy.wpp2 |> filter(time==2000) |> select(obs_value) |> pull()
v2 <- ilo.unemploy.wpp2 |> arrange(time) |> select(obs_value) |> last() |> pull()
v2_time <- ilo.unemploy.wpp2 |> arrange(time) |> select(time) |> last() |> pull()
ilo.df.blank$`2000`[2] <- ifelse(length(v1)==1,paste0(round(v1,1), " (2000)"),NA)
ilo.df.blank$Latest[2] <- ifelse(length(v2)==1,paste0(round(v2,1), " (",v2_time, ")"),NA)

#Share of youth (15-24) not in employment, education or training (NEET) (%)
ilo.neet.wpp <- ilo.neet.pct.est |> 
  left_join(wpp.location.area, by = c('ref_area' = 'iso3'))|>
  filter(sex == 'SEX_T', ref_area == country)
v1 <- ilo.neet.wpp |> filter(time==2000) |> select(obs_value) |> pull()
v2 <- ilo.neet.wpp |> arrange(time) |> select(obs_value) |> last() |> pull()
v2_time <- ilo.neet.wpp |> arrange(time) |> select(time) |> last() |> pull()
ilo.df.blank$`2000`[3] <- ifelse(length(v1)==1,paste0(round(v1,1), " (2000)"),NA)
ilo.df.blank$Latest[3] <- ifelse(length(v2)==1,paste0(round(v2,1), " (",v2_time, ")"),NA)

#Proportion of children engaged in economic activity (%)
ilo.chldlbr.wpp <- ilo.chldlbr |> 
  left_join(wpp.location.area, by = c('ref_area' = 'iso3'))|> group_by(ref_area) |>
  filter(sex == 'SEX_T', ref_area == country, classif1 == 'AGE_CLDVERSION_Y15-17') |> ungroup()
v1 <- ilo.chldlbr.wpp |> filter(time==2000) |> select(obs_value) |> pull()
v2 <- ilo.chldlbr.wpp |> arrange(time) |> select(obs_value) |> last() |> pull()
v2_time <- ilo.chldlbr.wpp |> arrange(time) |> select(time) |> last() |> pull()
ilo.df.blank$`2000`[4] <- ifelse(length(v1)==1,paste0(round(v1,1), " (2000"),NA)
ilo.df.blank$Latest[4] <- ifelse(is.na(v2),NA,paste0(round(v2,1), " (",v2_time, ")"))

#Working poverty rate (percentage of employed living below US$1.90 PPP)
ilo.wrkngpvrty.wpp <- ilo.wrkngpvrty |> 
  left_join(wpp.location.area, by = c('ref_area' = 'iso3'))|>
  filter(sex == 'SEX_T', ref_area == country, classif1 == 'AGE_YTHADULT_YGE15')
v1 <- ilo.wrkngpvrty.wpp |> filter(time==2000) |> select(obs_value) |> pull()
v2 <- ilo.wrkngpvrty.wpp |> arrange(time) |> select(obs_value) |> last() |> pull()
v2_time <- ilo.wrkngpvrty.wpp |> arrange(time) |> select(time) |> last() |> pull()
ilo.df.blank$`2000`[5] <- ifelse(length(v1)==1,round(v1,1),NA)
ilo.df.blank$Latest[5] <- ifelse(is.na(v2),NA,paste0(round(v2,1), "(",v2_time, ")"))

# create vector with colspan
myHeader <- c(" " = 1, country.wpp.name = 2)
names(myHeader) <- c(" ", country.wpp.name)

if(all(ilo.df.blank$Latest %in% c(NA, "NA (NA)"))){ #if there aren't any Labour values
  flag_ilo <-  F
} else {
  flag_ilo <-  T
  kable(ilo.df.blank,align = c('l','r','r'))  |> kable_classic(full_width = T) |>
    column_spec(1, bold = T, border_right = T,width = '12cm') |>
    add_header_above(myHeader) |>   row_spec( 0, extra_css = "border-top: 1px solid white")
}

```

**Youth unemployment rate** refers to the percentage of unemployed individuals in the age group of 15 to 24 years within the total labor force of the same age group in a particular country or region. This indicator is used to measure the degree to which young people are able to find employment opportunities and participate in the workforce. High youth unemployment rates can have negative social and economic consequences, such as reduced economic growth, increased poverty, and social unrest.

***Note:*** The unprecedented labour market shock created by the COVID-19 pandemic is difficult to assess by benchmarking against historical data (ILO).


```{r,fig.align = "center"}
#Youth unemployment rate chart
if( flag_ilo){
  data_chart6 <- ilo.unemploy.wpp2 |>
    filter(ref_area == country , sex == 'SEX_T' , classif1 == 'AGE_YTHADULT_Y15-24') |> 
    select(time, obs_value) |> 
    mutate( datatype = ifelse(time >2022, 'Projection','Estimation'))
  yr_bg3 <- min(data_chart6 |> pull(time))
  yr_ed3 <- max(data_chart6 |> pull(time))
}

```

`r if(flag_ilo){" <center> <font size = 3> **Youth (15-24) unemployment rate**</font>  </center> "}`

```{r,fig.align = "center"}
if( flag_ilo){
  fig_chart6 <- ggplot(data_chart6, aes(x = time,y = obs_value, fill = datatype))+
    geom_bar(stat = 'identity', alpha = 0.9 )+
    #geom_text(aes(label = round(obs_value,1)),vjust =0,size = 2.5)+
    scale_fill_manual(values = c('Projection' = unicef_colors_bin[2], 'Estimation' = unicef_colors_bin[1]))+
    labs(y = 'Rate (%)',
         x = 'Year',
         fill = NULL)+
    blank_theme+
    ylim(0,NA)+
    theme(axis.text.x = element_text(angle=45),
          plot.title=element_text(size=14, face="bold"),
          legend.position = "none",
          panel.grid.major.y = element_line(color=unicef_colors[9], linetype = "dashed"))

  fig_chart6}
```

`r if(flag_ilo){"<font size = 1><em>***Source:*** International Labour Organization, 2023. ILOSTAT database, https://ilostat.ilo.org/data. Accessed on 17/04/2023. </em></font>"}`

`r if(!flag_ilo){"<font size = 1><em>***Note:*** Currently no data for this indicator for this country. </em></font>"}`

### Economic indicators

National economic indicators are statistics that measure the performance and health of a country's economy. These indicators provide information on the country's overall economic activity, growth, and development.

```{r, message = F, include=F}
my_indicators <- c("GNI per capita, Atlas method (current US$) " = "NY.GNP.PCAP.CD",
                   "GDP per capita (current US$) " = "NY.GDP.PCAP.CD",
                   "Poverty headcount ratio at national poverty lines (% of population) " = "SI.POV.NAHC",
                   "Statistical Capacity score  - (value 0-100)" = "IQ.SCI.OVRL",
                   "GDP growth (annual %)" = "NY.GDP.MKTP.KD.ZG")

out <- tryCatch({
  wb.df <- wb_data(my_indicators, country = country,
                   start_date = 2000, end_date = 2022, return_wide = FALSE) |> 
    mutate(date = as.character(date)) |> 
    mutate_if(is.numeric,~as.character(round(.,1))) |>
    group_by(indicator_id)|>
    #filter(!is.na(value)) |>
    filter(if(all(is.na(value))) date %in% c(2000,2022) else (date == 2000|!is.na(value))) |> 
    filter(date %in% c(2000,max(date))) |> 
    ungroup() |>
    mutate(value =ifelse(is.na(value), NA ,
                         ifelse(date != 2000, ifelse(indicator_id %in% c('NY.GNP.PCAP.CD','NY.GDP.PCAP.CD'),
                                                     paste0(format(round(as.numeric(value)),big.mark = ' '), ' (',date,')'),
                                                     paste0(format(round(as.numeric(value),1),big.mark = ' '), ' (',date,')')),
                                ifelse(indicator_id %in% c('NY.GNP.PCAP.CD','NY.GDP.PCAP.CD'),
                                       format(round(as.numeric(value)),big.mark = ' '),
                                       format(round(as.numeric(value),1),big.mark = ' ')))),
           date = ifelse(date == 2000,'2000','Latest')) |>
    left_join(OGHIST |> 
                filter(`...1` == country & date %in% c(2000,2021)) |>
                mutate(date = ifelse(date == 2021,'Latest',date)), by = c('date')) |>
    mutate(class.iso3 = ifelse(date == 'Latest',paste0(recode(class.iso3, 
                                                              L = 'Low income',
                                                              LM = 'Lower middle income',
                                                              UM = 'Upper middle income',
                                                              H = 'High income'),' (2021)'),
                               recode(class.iso3,
                                      L = 'Low income',
                                      LM = 'Lower middle income',
                                      UM = 'Upper middle income', 
                                      H = 'High income'))) |>
    select(indicator_id,date,value,'WB Income level' = class.iso3) |>
    spread('indicator_id','value') |>
    select(Labour = date,'WB Income level',
           "GNI per capita, Atlas method (current US$ ) " = "NY.GNP.PCAP.CD",
           "GDP per capita (current US$ )" = "NY.GDP.PCAP.CD",
           "GDP growth (annual %)" = "NY.GDP.MKTP.KD.ZG",
           "Poverty headcount ratio at national poverty lines (% of population) " = "SI.POV.NAHC",
           "Statistical Capacity score  - (value 0-100)" = "IQ.SCI.OVRL")
  
  dt5 <- wb.df|>
    pivot_longer(-Labour) |>
    pivot_wider(names_from=Labour, values_from=value)
  
  colnames(dt5) <- c('Indicator', '2000' ,'Latest')
  
  # create vector with colspan
  myHeader <- c(" " = 1, country.wpp.name = 2)
  names(myHeader) <- c(" ", country.wpp.name)
  
  kable(dt5, align = c('l','r','r'))  |>
    kable_classic(full_width = T) |>
    column_spec(1, bold = T, border_right = T,width = '12cm') |>
    add_header_above(myHeader) |> 
    row_spec( 0, extra_css = "border-top: 1px solid white")
  
  flag_wb <<- T
  
}, error = function(e){
  flag_wb <<- F
}
)

out
```

```{r, message=F,warning=F,out.width="50%"}

if(flag_wb){
data_chart78 <- wb_data(c("GDP growth" = "NY.GDP.MKTP.KD.ZG", "GNI.pcap" = "NY.GNP.PCAP.CD"), 
                        country = country, start_date = 1990, end_date = 2022, return_wide = FALSE) |>
  filter(!is.na(value))

yr_bg4 <- min(data_chart78 |> filter(indicator_id == "NY.GDP.MKTP.KD.ZG") |> pull(date))
yr_ed4 <- max(data_chart78 |> filter(indicator_id == "NY.GDP.MKTP.KD.ZG") |> pull(date))

yr_bg5 <- min(data_chart78 |> filter(indicator_id == 'NY.GNP.PCAP.CD') |> pull(date))
yr_ed5 <- max(data_chart78 |> filter(indicator_id == 'NY.GNP.PCAP.CD') |> pull(date))

fig_chart7 <- ggplot(data_chart78 |> filter(indicator_id == "NY.GDP.MKTP.KD.ZG"), aes(x = as.integer(date),y = value))+
  geom_line( color = unicef_colors_bin[1], size = 2)+
  geom_hline(yintercept = 0, color = unicef_colors[11])+
  labs(y = 'Per cent (%)',
       x = 'Year',
       title = "GDP growth (annual %)",
       #subtitle = paste0(name_of_country, ", ", yr_bg4,"-",yr_ed4),
       fill = NULL)+
  blank_theme+
  theme(legend.position="bottom",legend.direction="vertical",plot.title=element_text(size=14, face="bold"),
        panel.grid.major.y = element_line(color=unicef_colors[9], linetype = "dashed"))

fig_chart8 <- ggplot(data_chart78 |> filter(indicator_id == 'NY.GNP.PCAP.CD'), aes(x = as.integer(date),y = value))+
  geom_bar( stat = 'identity', fill = unicef_colors_bin[1])+
  labs(y = 'US$',
       x = 'Year',
       title = "GNI per capita, Atlas method (current US$))",
       #subtitle = paste0(name_of_country, ", ", yr_bg5,"-",yr_ed5),
       fill = NULL)+
  scale_x_continuous(breaks= pretty_breaks()) + 
  blank_theme+
  theme(legend.position="bottom",legend.direction="vertical",
        plot.title=element_text(size=14, face="bold"),
        panel.grid.major.y = element_line(color=unicef_colors[9], linetype = "dashed"))

print(fig_chart7)
print(fig_chart8)
}
```

`r if(flag_wb){"<font size = 1><em>***Source:*** World Bank, 2022. World Bank database, https://data.worldbank.org. </em></font>"}`

`r if(!flag_wb){"<font size = 1><em>***Note:*** Currently no data for this indicator for this country. </em></font>"}`
